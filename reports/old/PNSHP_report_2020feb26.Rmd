---
title: "PNSHP Spending and Project Summaries"
author: "B. Van Deynze"
date: "February 25, 2020"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
---
```{css style, echo=FALSE}
body .main-container {
  max-width: 1500px !important;
  # width: 1280px !important;
  margin-left: 50px !important;
}
body {
  max-width: 1400px !important;
}
```
```{r setup, include=FALSE}
# Set knitr options
knitr::opts_chunk$set(echo = FALSE)

# Clear existing environment
rm(list = ls())

# Set libraries
library(tidyverse)
library(janitor)
library(ggthemes)
library(scales)
library(searchable)

# Set ggplot2 themes
theme_set(theme_clean())
theme_update(plot.background = element_rect(color = NA))

# Set top-level working directory
wd <- "C:/Users/braeden.vandeynze/Documents/Salmon Cost Project/Analysis/"  # For Braeden; comment out for other users
knitr::opts_knit$set(root.dir = wd)
```

```{r data_prep, results='hide', warning=FALSE, message=FALSE}
# Load data ====
setwd(wd)
setwd("./output") # For Braeden; comment out for other users
df_pnshp <- read_csv("PNSHP_full_working.csv")
df_prj <- read_csv("PNSHP_prj_working.csv")

# Prep level lists and keys ====
df_pnshp <-
  df_pnshp %>%
  distinct(project_id, worksite_id, action, .keep_all = TRUE)
df_prj <-
  df_prj %>%
  distinct(project_id, .keep_all = TRUE)

action_key <-
  c(
    "ESTUARY/ NEARSHORE - CHANNEL MODIFICATION" = "est_chanmod",
    "ESTUARY/ NEARSHORE - CREATION OF NEW ESTUARINE HABITAT" = "est_create",
    "ESTUARY/ NEARSHORE - DIKE BREACHING/ REMOVAL" = "est_dikebreach",
    "ESTUARY/ NEARSHORE - DIKE RECONFIGURATION" = "est_dikereconf",
    "ESTUARY/ NEARSHORE - INVASIVE SPECIES TREATED" = "est_invasive",
    "ESTUARY/ NEARSHORE - REMOVAL OF EXISTING FILL MATERIAL" = "est_fillrem",
    "ESTUARY/ NEARSHORE - RESTORATION/REHABILITATION OF ESTUARINE HABITAT" = "est_resthab",
    "ESTUARY/ NEARSHORE - SHORELINE ARMOR REMOVAL OR MODIFICATION" = "est_armormod",
    "ESTUARY/ NEARSHORE - TIDEGATE ALTERATION/ REMOVAL" = "est_tidegate",
    "FISH PASSAGE - BARRIERS (DAMS OR LOG JAMS)" = "fishpass_barriers",
    "FISH PASSAGE - CULVERT IMPROVEMENTS OR UPGRADES" = "fishpass_culvimp",
    "FISH PASSAGE - CULVERT INSTALLATION" = "fishpass_culvinst",
    "FISH PASSAGE - CULVERT REMOVAL" = "fishpass_culvrem",
    "FISH PASSAGE - DIVERSION DAM/ PUSH UP DAM REMOVAL" = "fishpass_diverdam",
    "FISH PASSAGE - FISH LADDER IMPROVED" = "fishpass_ladderimp",
    "FISH PASSAGE - FISH LADDER INSTALLED" = "fishpass_ladderinst",
    "FISH PASSAGE - FISHWAYS (CHUTES OR POOLS) INSTALLED" = "fishpass_waysinst",
    "FISH PASSAGE - ROAD CROSSINGS IN STREAM (OTHER THAN CULVERTS)" = "fishpass_roadcross",
    "FISH PASSAGE - WEIRS (INCOMPLETE DAMS)" = "fishpass_weirs",
    "FISH PASSAGE IMPROVEMENT - ROCKED FORD- ROAD STREAM CROSSING" = "fishpass_rockford",
    "FISH SCREENING - FISH SCREEN INSTALLED" = "screen_inst",
    "FISH SCREENING - FISH SCREEN REPLACED" = "screen_replace",
    "INSTREAM - BEAVER INTRODUCTION" = "instream_beaver",
    "INSTREAM - BOULDERS" = "instream_boulder",
    "INSTREAM - CHANNEL CONNECTIVITY" = "instream_connect",
    "INSTREAM - CHANNEL RECONFIGURATION" = "instream_reconf",
    "INSTREAM - DEFLECTORS/ BARBS" = "instream_barbs",
    "INSTREAM - LARGE WOODY DEBRIS" = "instream_wooddebris",
    "INSTREAM - LOG WEIRS" = "instream_logweir",
    "INSTREAM - OFF CHANNEL HABITAT" = "instream_offchannel",
    "INSTREAM - PLANT REMOVAL/ CONTROL" = "instream_plantrem",
    "INSTREAM - PREDATOR REMOVAL PROJECT" = "instream_predrem",
    "INSTREAM - ROCK WEIRS" = "instream_rockweir",
    "INSTREAM - ROOTWADS" = "instream_rootwad",
    "INSTREAM - SPAWNING GRAVEL PLACEMENT" = "instream_gravel",
    "INSTREAM - STREAMBANK STABILIZATION" = "instream_bankstab",
    "INSTREAM - WOOD STRUCTURE/ LOG JAM" = "instream_logjam",
    "INSTREAM FLOW - IRRIGATION PRACTICE IMPROVEMENT" = "flow_irriimp",
    "INSTREAM FLOW - WATER LEASED OR PURCHASED" = "flow_waterlease",
    "LAND PROTECTED, ACQUIRED, OR LEASED - STREAMBANK PROTECTION" = "land_streambank",
    "LAND PROTECTED, ACQUIRED, OR LEASED - WETLAND OR ESTUARINE AREA PROTECTION" = "land_wetland",
    "NUTRIENT ENRICHMENT - CARCASS ANALOG" = "nutrient_carcanalog",
    "NUTRIENT ENRICHMENT - CARCASS PLACEMENT" = "nutrient_carcplace",
    "NUTRIENT ENRICHMENT - FERTILIZER" = "nutrient_fert",
    "PROJECT MAINTENANCE - SITE MAINTENANCE" = "projmaint_sitemaint",
    "RIPARIAN - CONSERVATION GRAZING MANAGEMENT" = "riparian_graze",
    "RIPARIAN - FENCING" = "riparian_fence",
    "RIPARIAN - FORESTRY PRACTICES/ STAND MANAGEMENT" = "riparian_forest",
    "RIPARIAN - LIVESTOCK EXCLUSION" = "riparian_liveexcl",
    "RIPARIAN - LIVESTOCK WATER DEVELOPMENT" = "riparian_livewater",
    "RIPARIAN - PLANTING" = "riparian_plant",
    "RIPARIAN - WATER GAP DEVELOPMENT" = "riparian_watergap",
    "RIPARIAN - WEED CONTROL" = "riparian_weed",
    "SEDIMENT REDUCTION - EROSION CONTROL STRUCTURES" = "sedireduce_contstruc",
    "SEDIMENT REDUCTION - ROAD DRAINAGE SYSTEM IMPROVEMENTS" = "sedireduce_roaddrain",
    "SEDIMENT REDUCTION - ROAD OBLITERATION" = "sedireduce_roadobli",
    "SEDIMENT REDUCTION - ROAD RECONSTRUCTION" = "sedireduce_roadrecon",
    "SEDIMENT REDUCTION - ROAD RELOCATION" = "sedireduce_roadrelo",
    "SEDIMENT REDUCTION - ROAD STREAM CROSSING IMPROVEMENTS" = "sedireduce_roadcross",
    "SEDIMENT REDUCTION - SEDIMENT CONTROL" = "sedireduce_sedicont",
    "UPLAND AGRICULTURE - BEST MANAGEMENT PRACTICES/ AGRICULTURE MANAGEMENT" = "agri_mgmt",
    "UPLAND AGRICULTURE - BEST MANAGEMENT PRACTICES/ STRUCTURAL PRACTICES" = "agri_structure",
    "UPLAND AGRICULTURE - BEST MANAGEMENT PRACTICES/ VEGETATIVE AND TILLING PRACTICES" = "agri_tillage",
    "UPLAND LIVESTOCK - UPLAND EXCLUSION OR FENCING" = "livestock_fence",
    "UPLAND LIVESTOCK - UPLAND GRAZING MANAGEMENT" = "livestock_graze",
    "UPLAND LIVESTOCK - WATER DEVELOPMENT" = "livestock_water",
    "UPLAND VEGETATION - INVASIVE PLANT CONTROL" = "uplandveg_invasive",
    "UPLAND VEGETATION - PLANTING" = "uplandveg_plant",
    "UPLAND VEGETATION - SLOPE STABILIZATION" = "uplandveg_slope",
    "UPLAND VEGETATION - VEGETATION/ STAND MANAGEMENT" = "uplandveg_standmgmt",
    "WATER QUALITY IMPROVEMENT - LIVESTOCK MANURE MANAGEMENT" = "wqimp_manure",
    "WATER QUALITY IMPROVEMENT - REFUSE REMOVAL" = "wqimp_refuse",
    "WATER QUALITY IMPROVEMENT - RETURN FLOW COOLING" = "wqimp_flowcool",
    "WATER QUALITY IMPROVEMENT - SEWAGE CLEAN-UP" = "wqimp_sewage",
    "WATER QUALITY IMPROVEMENT - STORMWATER/WASTEWATER" = "wqimp_wastewater",
    "WATER QUALITY IMPROVEMENT - TOXIC CLEAN-UP" = "wqimp_toxic",
    "WETLAND - PLANT REMOVAL/ CONTROL" = "wetland_plantrem",
    "WETLAND - PLANTING" = "wetland_plant",
    "WETLAND - WETLAND CREATION" = "wetland_create",
    "WETLAND - WETLAND IMPROVEMENT/ ENHANCEMENT" = "wetland_imp",
    "WETLAND - WETLAND INVASIVE SPECIES REMOVAL" = "wetland_invasive",
    "WETLAND - WETLAND RESTORATION" = "wetland_restore"
  )

action_levels <-
  df_pnshp %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  tabyl(action_full) %>%
  arrange(-n) %>%
  pull(action_full)

basin_levels <-
  df_pnshp %>%
  tabyl(basin) %>%
  arrange(-n) %>%
  pull(basin)

source_levels <-
  df_pnshp %>%
  tabyl(project_source) %>%
  arrange(-n) %>%
  pull(project_source)

basin_levels_prj <-
  df_prj %>%
  tabyl(basin) %>%
  arrange(-n) %>%
  pull(basin)

source_levels_prj <-
  df_prj %>%
  tabyl(project_source) %>%
  arrange(-n) %>%
  pull(project_source)

action_levels_spend <-
  df_prj %>%
  ungroup() %>%
  filter(adj_cost < 50000000) %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE))
  ) %>%
  pivot_longer(
    everything(),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  arrange(-adj_cost) %>%
  pull(action_full)

basin_levels_spend <-
  df_prj %>%
  filter(adj_cost < 50000000) %>%
  group_by(basin) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
  arrange(-adj_cost) %>%
  pull(basin)

source_levels_spend <-
  df_prj %>%
  filter(adj_cost < 50000000) %>%
  group_by(project_source) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
  arrange(-adj_cost) %>%
  pull(project_source)

```

## Data Background
The Pacific Northwest Salmonoid Habitat Projects (PNSHP) data set brings together data on habitat restoration actions related directly or indirectly to salmonoid habitat in Oregon, Washington, Idaho, and Montana. *Actions* are categorized in to one of 82 action types and grouped by a geo-coded *work site*. Work sites are further grouped by *project*. Project-level information is available on the *source* (who reported the project, often a funder or another database) and *expenditures*. For many projects, information on the *extent* of the action taken (e.g. length of stream or road treated, area treated) is also available, though how this information is structured varies widely by action-type, source, and project complexity.

In this document, we include projects between 1991 and 2015 (25 years). During this period, the number of ESA-listed salmon Evolutionarily Significant Units (ESUs) grew from zero to 19 (including steelhead). The first listing was Snake River sockeye, listed as endangered in 1991. The most recent listing was the Oregon coast coho, listed as threatened in 2008. This period also covers major changes in available financing for the habitat projects. A major population boom in the region, especially in the Puget Sound basin, increased the tax base for state-funded projects (while simultaneously increasing pressure on salmon habitat via development and water demands). The financial crisis of 2008 also lead to funding cuts across government agencies. Because projects are added to the database in batches and in a rolling fashion, I include only projects up to 2015.

### Project Structure Typology
Due to differences in how projects are funded, organized, and reported across sources, project data are structured in different ways. Some projects are quite complex, spanning dozens work sites miles apart with different actions at each. Some are simple, consisting of a single action at a single worksite. Many are in-between, consisting of a handful of work site with the same action or a single work site with many actions.

To make matters more complex, *project costs* (i.e. expenditures) are always reported at the project level (rather than the action or worksite level), while it appears that *metrics* (i.e. extent of action) are sometimes reported at the project level, sometimes at the worksite level, and sometimes at the individual action level. This makes directly comparing average costs (i.e. expenditures per unit) between projects difficult.

Below, I present a typology of projects based on their structure. I distinguish between the number of worksites, the number of actions, and the consistency of action profiles (i.e. what actions are taken) across sites. I also include the number of projects that fall into each category. I have also begun work classifying the metric structures within these categories, but idiosyncrasies and edge cases have made creating a consistent, managable typology over metric structure difficult. This typology could also include project cost availabilty, which is about 66% for all projects.

The majority of projects fall into either the single work site, single action type category. Among multiple work site projects, the majority fall into the single action type category, which will greatly simplify subsequent analysis (at least when metrics are consistently reported within the project). For multiple action type projects, directly modeling average costs will be difficult, as distinguishing between spending on different action types is impossible. One approach may be to model individual actions and use multiple action type projects as a check, using single action type model results to project expected costs for multiple action type projects and compare projected and observed total project costs between the two.

<blockquote>
<b>All projects</b> (n = 29,919)
<ul>
    <li>Single work site (n = 24,135)
        <ul>
            <li>Single action type (n = 18,080)</li>
            <li>Multiple action types (n = 6,055)</li>
        </ul>
    </li>
    <li>Multiple work sites (n = 5,784)
        <ul>
            <li>Single action type (n = 3,101)</li>
            <li>Multiple action types (n = 2,683)
                <ul>
                    <li>Single action type at each site (n = 168)</li>
                    <li>Multiple action types at some or all sites (n = 2,515)
                        <ul>
                            <li>Same action types at all sites (n = 1,912)</li>
                            <li>Different action types at some or all sites (n = 603)</li>
                        </ul>
                    </li>
                </ul>
            </li>
        </ul>
    </li>
</ul>
</blockquote>

### Source Glossery
Thirty-eight different organizations, referred to as *sources*, contribute data to PNSHP. Below you will find a glossery of each source code.

>
**ASOTIN** - Asotin County Conservation Distrcit (Asotin County is the southeastern-most county in Washington and contains important Snake River watersheds)  
**BLM** - Bureau of Land Managmeent  
**BOR** - Bureau of Reclamation (Department of the Interior agency responsible for water storage and irrigation, including federal dams)  
**BPA** - Bonneville Power Administration  
**CBFWA** - Columbia Basin Fish and Wildlife Authority (Now defunct group of state, federal, and tribal agencies organized to advise BPA on habitat improvement efforts)  
**CHEHALIS** - Chehalis Tribe (Southewestern Washington)  
**COLVILLE** - Colville Tribe (Northeastern Washington)  
**COQUILLE** - Coquille Tribe (Southwestern Oregon)  
**COWLITZ** -  Cowlitz Tribe (Northeastern Washington)  
**CRITFC** - Columbia River Inter-Tribal Fisheries Commission  
**DUCKS UNLIMITED** - Ducks Unlimited  
**FISHER FISHERIES** - Fisher Fisheries Consultancy  
**GRAND RONDE** - Grand Ronde Tribe (Central Western Oregon)  
**GRMWP** - Grande Ronde Model Watershed Program (Northeastern Oregon river)  
**HABITAT WORK SCHEDULE** - Washington State program for tracking projects by the 27 "Lead Entities", local boards responsible for managing state salmon habitat spending  
**ID OSC** - Idaho Office of Species Conservation  
**IDAHODEQ** - Idaho Department of Environmental Quality  
**IDFG** - Idaho Department of Fish and Game  
**IDFG SCREEN SHOP** - Fish screen efforts for IDFG  
**KRITFWC** - Klamath River Inter-Tribal Fish and Water Commission (Southern Oregon river)  
**MONTANA WATER CENTER** - Research instiute  based at Montana State  
**NMFS** - NOAA Fisheries  
**NOAA RESTORATION** - NOAA Restoration Center  
**NRRSS** - National River Restoration Science Synthesis project (a project of American Rivers)  
**NWIFC** - Northwest Indian Fisheries Commission  
**OR WATER TRUST** - Oregon Water Trust  
**OWRI** - Oregon Watershed Restoration Inventory  
**PCSRF** - Pacific Coastal Salmon Recovery Fund (federal grant program adminstered by NOAA)  
**REO** - United States Forest Service Region 6 Regional Ecosystem Office  
**SHOSHONE-BANNOCK** - Shoshone-Bannock Tribes (Southeastern Idaho)  
**SRFBD** - Salmon Funding Recovery Board Database (Washington State Recreation and Conservation Office grant program)  
**STREAMNET** - Data project of the Pacific States Marine Fisheries Commission  
**WA DOE** - Washington State Department of Ecology  
**WA RCO** - Washington State Recreation and Conservation Office  
**WA WATER TRUST** - Washington Water Trust  
**WDFW FISHWAY** - Washinton State Department of Fish and Wildlife (WDFW) Fishway Program  
**WDFW WRIP** - WDFW Watershed Recovery Inventory Project  
**WDOT** - Washington Department of Transportation  

## Action and Project Counts
In this section, I visualize the number of actions in the PNSHP data set by (a) action type, (b) year, (c) basin, and (d) source (and cross-tabulations). Counts of projects are also presented by (a) year, (b) basin, and (c) source (and cross-tabulations). These figures illustrate trends in project and action quantity over time and differences in actions taken across space, while also highlighting potential differences in reporting across different sources and regions.

### Observations
1. Road drainage system improvements are by far the most common actions. Most of these actions occurred between 1995 and 2005 in Western Oregon (Willamette, Southern Oregon Coastal, and Northern Oregon Coastal basins), and are reported through the Oregon Watershed Restoration Inventory (OWRI). Road obliterations follow a similar pattern. These actions are the fifth mos common, are also concentrated in Western Oregon during the same period, and are mostly reported through OWRI. While these types of road improvement projects improve salmon habitat by improving water quality, they are likely not directly targeting salmon habitat. There also appears to be inconsistent reporting between Oregon and Washington for these sorts of projects.
2. More direct habitat improvements like plantings, stream-flow alterations (e.g. large woody debris, boulders, log jams, etc.), and weeding are widely and consistently documented. These sorts of actions are likely directly comparable in terms of costs.
3. Culvert-related projects (upgrades and removals) are quite common and consistently reported over time and space. The reporting of culvert projects does not follow the pattern of Oregon roadwork projects and is more widespread over several basins and reporting sources.
4. Livestock (including riparian fencing) and upland actions are common, but mainly reported by Bureau of Land Management (BLM). These actions are likely more targeted towards general watershed improvements rather than salmon habitat in particular.
5. Both the number of projects and the number of actions peak in the early '00s. The number of actions and projects collapses during the recession, likely due to a lack of funding. The number of projects per year does not recover to pre-recession levels, while the number of actions does see a bump in the early '10s, indicating an increase in the number of actions reported per project.
6. Are differences in the types of actions reported because of differences in actions taken across space (e.g. Oregon vs. Washington) or are they due to differences in reporting (e.g. OWRI vs. Habitat Work Schedule)? How might this affect our ability to model costs across the full region?
7. Will the lack of roadwork actions reported outside of Oregon affect the external validity of models for these action types? Any roadwork action model will be dominated by OWRI projects, while Washington does not have an analogue reporting system for these sorts of projects.

### Count Figures {.tabset .tabset-fade .tabset-pills}
*To view high-resolution figure, right click and select "Open image in new tab".*

#### Counts of Actions

```{r action_counts1, fig.dim = c(12, 10)}
# Action count, by type ====
df_fig_count_type <-
  df_pnshp %>%
  group_by(action) %>%
  summarize(n = n()) %>%
  mutate(action_full = recode(action, !!!invert(action_key)))

fig_count_type <-
  ggplot(
    df_fig_count_type %>% filter(action_full %in% action_levels[1:50]),
    aes(
      x = reorder(action_full, n),
      y = n
    )
  ) +
  ggtitle("Action count, by action type", "50 (of 82) most common action types") +
  
  geom_col(
    aes(
      fill = -n
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_count_type

```

```{r action_counts2, fig.dim = c(12, 10)}
# Aciton count, by year ====
df_fig_count_year <-
  df_pnshp %>%
  group_by(completed_year) %>%
  summarize(n = n())

fig_count_year <-
  ggplot(
    df_fig_count_year,
    aes(
      x = completed_year,
      y = n
    )
  ) +
  ggtitle("Action count, by year") +
  
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  )
fig_count_year
```

```{r action_counts3, fig.dim = c(12, 10)}
# Action count, by basin ====
df_fig_count_basin <-
  df_pnshp %>%
  group_by(basin) %>%
  summarize(n = n()) %>%
  mutate(basin_fac = factor(basin, basin_levels, ordered = TRUE))

fig_count_basin <-
  ggplot(
    df_fig_count_basin %>% filter(!is.na(basin)),
    aes(
      x = reorder(basin, n),
      y = n
    )
  ) +
  ggtitle("Action count, by basin") +
  
  geom_col(
    aes(
      fill = -n
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_count_basin
```

```{r action_counts4, fig.dim = c(12, 10)}
# Action count, by funding ====
df_fig_count_source <-
  df_pnshp %>%
  group_by(project_source) %>%
  summarize(n = n()) %>%
  mutate(source_fac = factor(project_source, source_levels, ordered = TRUE))

fig_count_source <-
  ggplot(
    df_fig_count_source %>% filter(!is.na(project_source)),
    aes(
      x = reorder(project_source, n),
      y = n
    )
  ) +
  ggtitle("Action count, by source") +
  
  geom_col(
    aes(
      fill = -n
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_count_source
```

```{r action_counts5, fig.dim = c(12, 20)}
# Action count, by year and type ====
df_fig_count_year_type <-
  df_pnshp %>%
  group_by(action, completed_year) %>%
  summarize(n = n()) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  mutate(action_fac = factor(action_full, action_levels, ordered = TRUE))

fig_count_year_type <-
  ggplot(
    df_fig_count_year_type %>%
      filter(action_full %in% action_levels[1:18]),
    aes(
      x = completed_year,
      y = n
    )
  ) +
  ggtitle("Action count, by year and action type", "18 (of 82) most common action types") +
  
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5),
    strip.text = element_text(size = 8)
  ) +
  facet_wrap(~ action_fac, ncol = 3)
fig_count_year_type
```

```{r action_counts6, fig.dim = c(12, 16)}
# Action count, by basin and type ====
df_fig_count_basin_type <-
  df_pnshp %>%
  group_by(action, basin) %>%
  summarize(n = n()) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  mutate(action_fac = factor(action_full, action_levels, ordered = TRUE)) %>%
  mutate(basin_fac = factor(basin, basin_levels, ordered = TRUE))

fig_count_basin_type <-
  ggplot(
    df_fig_count_basin_type %>%
      filter(
        action_full %in% action_levels[1:16]
      ) %>%
      filter(
        basin %in% basin_levels[1:12]
      ),
    aes(
      x = reorder(action_full, n),
      y = n
    )
  ) +
  ggtitle("Action count, by basin and type", "16 (of 82) most common action types in 12 (of 47) basins with most actions") +
  
  geom_col(
    aes(
      fill = -log(n)
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma()
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip() +
  facet_wrap(~ basin_fac, ncol = 3)
fig_count_basin_type
```

```{r action_counts7, fig.dim = c(12, 20)}
# Action count, by source and type ====
df_fig_count_source_type <-
  df_pnshp %>%
  group_by(action, project_source) %>%
  summarize(n = n()) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  mutate(action_fac = factor(action_full, action_levels, ordered = TRUE)) %>%
  mutate(source_fac = factor(project_source, source_levels, ordered = TRUE))

fig_count_source_type <-
  ggplot(
    df_fig_count_source_type %>%
      filter(
        action_full %in% action_levels[1:12]
      ) %>%
      filter(
        project_source %in% source_levels[1:15]
      ),
    aes(
      x = reorder(action_full, n),
      y = n
    )
  ) +
  ggtitle("Action count, by source and type", "12 (of 82) most common action types by 15 sources (of 38) with most actions \nNote X-axis varies by source") +
  
  geom_col(
    aes(
      fill = -log(n)
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma()
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip() +
  facet_wrap(~ source_fac, scales = "free_x", ncol = 3)
fig_count_source_type
```

```{r action_counts8, fig.dim = c(12, 10)}
# Action count, by source and year ====
df_fig_count_source_year <-
  df_pnshp %>%
  group_by(completed_year, project_source) %>%
  summarize(n = n()) %>%
  mutate(source_fac = factor(project_source, source_levels, ordered = TRUE))

fig_count_source_year <-
  ggplot(
    df_fig_count_source_year %>%
      filter(
        project_source %in% source_levels[1:20]
      ),
    aes(
      x = completed_year,
      y = n
    )
  ) +
  ggtitle("Action count, by source and year", "20 sources (of 38) with most actions") +
  
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  ) +
  facet_wrap(~ source_fac)
fig_count_source_year
```

```{r action_counts9, fig.dim = c(12, 10)}
# Action count, by basin and year ====
df_fig_count_basin_year <-
  df_pnshp %>%
  group_by(completed_year, basin) %>%
  summarize(n = n()) %>%
  mutate(basin_fac = factor(basin, basin_levels, ordered = TRUE))

fig_count_basin_year <-
  ggplot(
    df_fig_count_basin_year %>%
      filter(
        basin %in% basin_levels[1:12]
      ),
    aes(
      x = completed_year,
      y = n
    )
  ) +
  ggtitle("Action count, by basin and year", "12 basins (of 47) with most actions") +
  
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  ) +
  facet_wrap(~ basin_fac)
fig_count_basin_year
```

```{r action_counts10, fig.dim = c(12, 10)}
# Action count, by basin and funding ====
df_fig_count_basin_source <-
  df_pnshp %>%
  group_by(project_source, basin) %>%
  summarize(n = n()) %>%
  mutate(source_fac = factor(project_source, source_levels, ordered = TRUE)) %>%
  mutate(basin_fac = factor(basin, basin_levels, ordered = TRUE))

fig_count_basin_source <-
  ggplot(
    df_fig_count_basin_source %>%
      filter(
        project_source %in% source_levels[1:16]
      ) %>%
      filter(
        basin %in% basin_levels[1:10]
      ),
    aes(
      x = reorder(basin, n),
      y = n
    )
  ) +
  ggtitle("Action count, by basin and funding source", "10 basins (of 47) and 16 sources (of 38) with most actions") +
  
  geom_col(
    aes(
      fill = -log(n)
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma()
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip() +
  facet_wrap(~ source_fac)
fig_count_basin_source
```

#### Counts of Projects

```{r project_counts1, fig.dim = c(12, 10)}
# Project count, by year ====
df_fig_prj_year <-
  df_prj %>%
  group_by(completed_year) %>%
  summarize(n = n())

fig_prj_year <-
  ggplot(
    df_fig_prj_year,
    aes(
      x = completed_year,
      y = n
    )
  ) +
  ggtitle("Project count, by year") +
  
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  )
fig_prj_year
```

```{r project_counts2, fig.dim = c(12, 10)}
# Project count, by basin ====
df_fig_prj_basin <-
  df_prj %>%
  group_by(basin) %>%
  summarize(n = n()) %>%
  mutate(basin_fac = factor(basin, basin_levels_prj, ordered = TRUE))

fig_prj_basin <-
  ggplot(
    df_fig_prj_basin %>% filter(!is.na(basin)),
    aes(
      x = reorder(basin, n),
      y = n
    )
  ) +
  ggtitle("Project count, by basin") +
  
  geom_col(
    aes(
      fill = -n
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_prj_basin

```

```{r project_counts3, fig.dim = c(12, 10)}
# Project count, by funding ====
df_fig_prj_source <-
  df_prj %>%
  group_by(project_source) %>%
  summarize(n = n()) %>%
  mutate(source_fac = factor(project_source, source_levels_prj, ordered = TRUE))

fig_prj_source <-
  ggplot(
    df_fig_prj_source %>% filter(!is.na(project_source)),
    aes(
      x = reorder(project_source, n),
      y = n
    )
  ) +
  ggtitle("Project count, by source") +
  
  geom_col(
    aes(
      fill = -n
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_prj_source

```

```{r project_counts4, fig.dim = c(12, 10)}
# Project count, by funding and year ====
df_fig_prj_source_year <-
  df_prj %>%
  group_by(completed_year, project_source) %>%
  summarize(n = n()) %>%
  mutate(source_fac = factor(project_source, source_levels_prj, ordered = TRUE))

fig_prj_source_year <-
  ggplot(
    df_fig_prj_source_year %>%
      filter(
        project_source %in% source_levels_prj[1:20]
      ),
    aes(
      x = completed_year,
      y = n
    )
  ) +
  ggtitle("Project count, by source and year", "20 sources (of 38) with most actions") +
  
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  ) +
  facet_wrap(~ source_fac)
fig_prj_source_year

```

```{r project_counts5, fig.dim = c(12, 10)}
# Project count, by basin and year ====
df_fig_prj_basin_year <-
  df_prj %>%
  group_by(completed_year, basin) %>%
  summarize(n = n()) %>%
  mutate(basin_fac = factor(basin, basin_levels_prj, ordered = TRUE))

fig_prj_basin_year <-
  ggplot(
    df_fig_prj_basin_year %>%
      filter(
        basin %in% basin_levels_prj[1:12]
      ),
    aes(
      x = completed_year,
      y = n
    )
  ) +
  ggtitle("Project count, by basin and year", "12 basins (of 47) with most actions") +
  
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  ) +
  facet_wrap(~ basin_fac)
fig_prj_basin_year

```

```{r project_counts6, fig.dim = c(12, 10)}
# Project count, by basin and funding ====
df_fig_prj_basin_source <-
  df_prj %>%
  group_by(project_source, basin) %>%
  summarize(n = n()) %>%
  mutate(source_fac = factor(project_source, source_levels_prj, ordered = TRUE)) %>%
  mutate(basin_fac = factor(basin, basin_levels_prj, ordered = TRUE))

fig_prj_basin_source <-
  ggplot(
    df_fig_prj_basin_source %>%
      filter(
        project_source %in% source_levels_prj[1:16]
      ) %>%
      filter(
        basin %in% basin_levels_prj[1:10]
      ),
    aes(
      x = reorder(basin, n),
      y = n
    )
  ) +
  ggtitle("Project count, by basin and source", "10 basins (of 47) and 16 funders (of 38) with most actions") +
  
  geom_col(
    aes(
      fill = -log(n)
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma()
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip() +
  facet_wrap(~ source_fac)
fig_prj_basin_source

```

## Expenditures
```{r spending_calcs, include = FALSE}
total_expenditures <- df_prj %>% pull(adj_cost) %>% sum(na.rm = TRUE) %>% format(big.mark = ",")
avail_expenditures_count <- df_prj %>% pull(adj_cost) %>% is.na() %>% sum(na.rm = TRUE)
avail_expenditures_count <- nrow(df_prj) - avail_expenditures_count
avail_expenditures_pct <- ((avail_expenditures_count / nrow(df_prj)) * 100) %>% format(digits = 3)
```
In this section, I visualize reported expenditures over (a) action type, (b) year, (c) basin, and (d) source (and selected cross-tabulations). Note that a single project will fall into multiple action type categories if the project consists of multiple action types. All expenditures are converted to 2019 dollars via FRED Implicit Price Deflator. Three projects were removed as outliers in their spending levels (see note below).

Expenditures are available for `r format(avail_expenditures_count, big.mark = ",")` projects, or `r avail_expenditures_pct`% of `r format(nrow(df_prj), big.mark = ",")` projects. In total, the PNSHP data set reports \$`r total_expenditures` in expenditures across all 25 years.

### Observations
1. When I first ran these, there was a crazy peak in spending in the Willamette basin in 1991. Further investigation reveals that this is due to two projects reported in the Willamette by NRRSS in 1991. Both projects are involve "Water Quality Improvement - Return Flow Cooling", and one involves fish screen installation. The more expensive of the two cost over \$110 million while the other cost just shy of \$64 million. These two return flow cooling projects are two of only 21 projects reported that involve this action type. A third 1997 NRRSS-reported toxic water clean-up project in the Pend Orielle basin has a reported cost of around \$54 million. The next most expensive project has a reported cost of only $14 million. Given their outlier status, these NRRSS projects will be removed from future analysis.
2. Only 22 of the 38 sources report any costs at all. The top six sources account for the vast majority of reported spending. An obvious next step will be to calculate cost reporting rates by source.
3. Projects involving direct habitat interventions like riparian planting and in-stream placement of large woody debris, log jams, weirs, rootwads, and boulders make up the bulk of the spending. For multiple action projects, these sorts of actions tend to be reported together, which might explain their clustering at the top the total expenditure figures. These projects appear throughout the region, but Puget Sound has seen the most investment by a wide margin. Overall, these projects are the most widespread and represent the bulk of spending.
4. Over $250mill has been spent on culvert improvement projects, making it the action with the third highest associated expenditures. However, per project costs for these projects is ranked much lower. This spending is spread concentrated along the western side of the Cascades (Puget Sound, Oregon Coastal, Willamette).
5. The bulk of the land acquisition spending is in the Puget Sound. Habitat Work Schedule and WA RCO (including SRFBD projects) report the most spending on these projects, and both operate mainly in the Puget Sound region. On the other hand, OWRI does not report land acquisition projects, so we may be getting an incomplete picture of acquisition activity in Oregon.
6. Expenditures have been rising overall and for almost all major actions over time, with the exception of road drainage improvements (see note in the Action and Project Counts section above). Expenditures per project and per action have been rising over time as well. As seen in the Counts figures, there is a noticeable drop in spending in the year of the financial crisis, though overall spending quickly recovers.

### Expenditure Figures {.tabset .tabset-fade .tabset-pills}
*To view high-resolution figure, right click and select "Open image in new tab".*
```{r spending_prep, include = FALSE}
df_prj <-
  df_prj %>%
  filter(
    adj_cost < 50000000
  )
```

#### Total
```{r spending_totals1, fig.dim = c(12, 10)}
# Spending total, by action ====
df_fig_spend_action <-
  df_prj %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE))
  ) %>%
  pivot_longer(
    everything(),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key)))

fig_spend_action <-
  ggplot(
    df_fig_spend_action %>%
      filter(action_full %in% action_levels[1:50]),
    aes(
      x = reorder(action_full, adj_cost),
      y = adj_cost/1000
    )
  ) +
  ggtitle("Expenditures ($thou), by action type", "50 (of 82) most common action types") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_spend_action

```

```{r spending_totals2, fig.dim = c(12, 10)}
df_fig_spend_year <-
  df_prj %>%
  group_by(project_year) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE))

fig_spend_year <-
  ggplot(
    df_fig_spend_year,
    aes(
      x = project_year,
      y = adj_cost/1000
    )
  ) +
  ggtitle("Expenditures ($thou), by year") +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  )
fig_spend_year
```

```{r spending_totals3, fig.dim = c(12, 10)}
# Spending total, by basin ====
df_fig_spend_basin <-
  df_prj %>%
  group_by(basin) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
  drop_na()

fig_spend_basin <-
  ggplot(
    df_fig_spend_basin,
    aes(
      x = reorder(basin, adj_cost),
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures ($thou), by basin") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_spend_basin
```

```{r spending_totals4, fig.dim = c(12, 10)}
# Spending total, by source ====
df_fig_spend_source <-
  df_prj %>%
  group_by(project_source) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
  drop_na()

fig_spend_source <-
  ggplot(
    df_fig_spend_source,
    aes(
      x = reorder(project_source, adj_cost),
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures ($thou), by source") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_spend_source
```

```{r spending_totals5, fig.dim = c(12, 20)}
# Spending total, by year and action ====
df_fig_spend_year_action <-
  df_prj %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  group_by(project_year) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE))
  ) %>%
  pivot_longer(
    starts_with("action_"),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE))

fig_spend_year_action <-
  ggplot(
    df_fig_spend_year_action %>%
      filter(action_full %in% action_levels_spend[1:18]),
    aes(
      x = project_year,
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures ($thou), by year and action type", "18 (of 82) action types with highest expenditures") +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5),
    strip.text = element_text(size = 8)
  ) +
  facet_wrap(~ action_fac, ncol = 3)
fig_spend_year_action
```

```{r spending_totals6, fig.dim = c(12, 10)}
# Spending total, by year and basin ====
df_fig_spend_year_basin <-
  df_prj %>%
  group_by(project_year, basin) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
  drop_na() %>%
  mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE))

fig_spend_year_basin <-
  ggplot(
    df_fig_spend_year_basin %>%
      filter(basin %in% basin_levels_spend[1:12]),
    aes(
      x = project_year,
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures ($thou), by year and basin", "12 (of 47) basins with highest expenditures") +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  ) +
  facet_wrap(~ basin_fac, ncol = 3)
fig_spend_year_basin

```

```{r spending_totals7, fig.dim = c(12, 10)}
# Spending total, by year and source ====
df_fig_spend_year_source <-
  df_prj %>%
  group_by(project_year, project_source) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
  drop_na() %>%
  mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE))

fig_spend_year_source <-
  ggplot(
    df_fig_spend_year_source %>%
      filter(project_source %in% source_levels_spend[1:8]),
    aes(
      x = project_year,
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures ($thou), by year and source", "8 (of 38) sources with highest reported expenditures") +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  ) +
  facet_wrap(~ source_fac, ncol = 2)
fig_spend_year_source
```

```{r spending_totals8, fig.dim = c(12, 20)}
# Spending total, by basin and action ====
df_fig_spend_basin_action <-
  df_prj %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  group_by(basin) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE))
  ) %>%
  pivot_longer(
    starts_with("action_"),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
  mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE))

fig_spend_basin_action <-
  ggplot(
    df_fig_spend_basin_action %>%
      filter(action_full %in% action_levels_spend[1:16]) %>%
      filter(basin %in% basin_levels_spend[1:8]),
    aes(
      x = reorder(action_full, adj_cost),
      y = adj_cost/1000
    )
  ) +
  ggtitle("Expenditures ($thous), by basin and action type", "16 (of 82) action types with highest expenditures in \n8 (of 47) basins with highest expenditures") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none",
    axis.text.y.left = element_text(size = 8)
  ) +
  coord_flip() +
  facet_wrap(~ basin_fac, ncol = 2)
fig_spend_basin_action
```

```{r spending_totals9, fig.dim = c(12, 20)}
# Spending total, by source and action ====
df_fig_spend_source_action <-
  df_prj %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  group_by(project_source) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE))
  ) %>%
  pivot_longer(
    starts_with("action_"),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
  mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE))

fig_spend_source_action <-
  ggplot(
    df_fig_spend_source_action %>%
      filter(action_full %in% action_levels_spend[1:16]) %>%
      filter(project_source %in% source_levels_spend[1:8]),
    aes(
      x = reorder(action_full, adj_cost),
      y = adj_cost/1000
    )
  ) +
  ggtitle("Expenditures ($thous), by source and action type", "16 (of 82) action types with highest expenditures by \n8 (of 38) sources with highest expenditures") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none",
    axis.text.y.left = element_text(size = 8)
  ) +
  coord_flip() +
  facet_wrap(~ source_fac, ncol = 2)
fig_spend_source_action
```

#### Per Project
*Note:* These figures represent expenditures per project *with reported costs*.

```{r spending_proj1, fig.dim = c(12, 10)}
# Spending total, by action ====
df_fig_spend_action <-
  df_prj %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE)/sum(I(. > 0)))
  ) %>%
  pivot_longer(
    everything(),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key)))

fig_spend_action <-
  ggplot(
    df_fig_spend_action %>%
      filter(action_full %in% action_levels[1:50]),
    aes(
      x = reorder(action_full, adj_cost),
      y = adj_cost/1000
    )
  ) +
  ggtitle("Expenditures per project ($thou), by action type", "50 (of 82) most common action types") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_spend_action

```

```{r spending_proj2, fig.dim = c(12, 10)}
df_fig_spend_year <-
  df_prj %>%
  group_by(project_year) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE)/ sum(!is.na(adj_cost)))

fig_spend_year <-
  ggplot(
    df_fig_spend_year,
    aes(
      x = project_year,
      y = adj_cost/1000
    )
  ) +
  ggtitle("Expenditures per project ($thou), by year") +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  )
fig_spend_year
```

```{r spending_proj3, fig.dim = c(12, 10)}
# Spending total, by basin ====
df_fig_spend_basin <-
  df_prj %>%
  group_by(basin) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE)/ sum(!is.na(adj_cost))) %>%
  drop_na()

fig_spend_basin <-
  ggplot(
    df_fig_spend_basin,
    aes(
      x = reorder(basin, adj_cost),
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures per project ($thou), by basin") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_spend_basin
```

```{r spending_proj4, fig.dim = c(12, 10)}
# Spending total, by source ====
df_fig_spend_source <-
  df_prj %>%
  group_by(project_source) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(!is.na(adj_cost))) %>%
  drop_na()

fig_spend_source <-
  ggplot(
    df_fig_spend_source,
    aes(
      x = reorder(project_source, adj_cost),
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures per project ($thou), by source") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_spend_source
```

```{r spending_proj5, fig.dim = c(12, 20)}
# Spending total, by year and action ====
df_fig_spend_year_action <-
  df_prj %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  group_by(project_year) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE)/ sum(!is.na(adj_cost)))
  ) %>%
  pivot_longer(
    starts_with("action_"),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE))

fig_spend_year_action <-
  ggplot(
    df_fig_spend_year_action %>%
      filter(action_full %in% action_levels_spend[1:18]),
    aes(
      x = project_year,
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures per project ($thou), by year and action type", "18 (of 82) action types with highest expenditures") +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5),
    strip.text = element_text(size = 8)
  ) +
  facet_wrap(~ action_fac, ncol = 3)
fig_spend_year_action
```

```{r spending_proj6, fig.dim = c(12, 10)}
# Spending total, by year and basin ====
df_fig_spend_year_basin <-
  df_prj %>%
  group_by(project_year, basin) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(!is.na(adj_cost))) %>%
  drop_na() %>%
  mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE))

fig_spend_year_basin <-
  ggplot(
    df_fig_spend_year_basin %>%
      filter(basin %in% basin_levels_spend[1:12]),
    aes(
      x = project_year,
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures per project ($thou), by year and basin", "12 (of 47) basins with highest expenditures") +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  ) +
  facet_wrap(~ basin_fac, ncol = 3)
fig_spend_year_basin

```

```{r spending_proj7, fig.dim = c(12, 10)}
# Spending total, by year and source ====
df_fig_spend_year_source <-
  df_prj %>%
  group_by(project_year, project_source) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(!is.na(adj_cost))) %>%
  drop_na() %>%
  mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE))

fig_spend_year_source <-
  ggplot(
    df_fig_spend_year_source %>%
      filter(project_source %in% source_levels_spend[1:8]),
    aes(
      x = project_year,
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures per project ($thou), by year and source", "8 (of 38) sources with highest reported expenditures") +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  ) +
  facet_wrap(~ source_fac, ncol = 2)
fig_spend_year_source
```

```{r spending_proj8, fig.dim = c(12, 20)}
# Spending total, by basin and action ====
df_fig_spend_basin_action <-
  df_prj %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  group_by(basin) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE) / sum(!is.na(adj_cost)))
  ) %>%
  pivot_longer(
    starts_with("action_"),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
  mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE))

fig_spend_basin_action <-
  ggplot(
    df_fig_spend_basin_action %>%
      filter(action_full %in% action_levels_spend[1:16]) %>%
      filter(basin %in% basin_levels_spend[1:8]),
    aes(
      x = reorder(action_full, adj_cost),
      y = adj_cost/1000
    )
  ) +
  ggtitle("Expenditures per project ($thous), by basin and action type", "16 (of 82) action types with highest expenditures in \n8 (of 47) basins with highest expenditures") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none",
    axis.text.y.left = element_text(size = 8)
  ) +
  coord_flip() +
  facet_wrap(~ basin_fac, ncol = 2)
fig_spend_basin_action
```

```{r spending_proj9, fig.dim = c(12, 20)}
# Spending total, by source and action ====
df_fig_spend_source_action <-
  df_prj %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  group_by(project_source) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE) / sum(!is.na(adj_cost)))
  ) %>%
  pivot_longer(
    starts_with("action_"),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
  mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE))

fig_spend_source_action <-
  ggplot(
    df_fig_spend_source_action %>%
      filter(action_full %in% action_levels_spend[1:16]) %>%
      filter(project_source %in% source_levels_spend[1:8]),
    aes(
      x = reorder(action_full, adj_cost),
      y = adj_cost/1000
    )
  ) +
  ggtitle("Expenditures per project ($thous), by source and action type", "16 (of 82) action types with highest expenditures by \n8 (of 38) sources with highest expenditures") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none",
    axis.text.y.left = element_text(size = 8)
  ) +
  coord_flip() +
  facet_wrap(~ source_fac, ncol = 2)
fig_spend_source_action
```

#### Per Action
*Note:* These figures represent expenditures per action for projects *with reported costs*. Results by action still in progress and are omitted here.

```{r spending_act1, fig.dim = c(12, 10), include = FALSE}
# Spending total, by action ====
df_fig_spend_action <-
  df_prj %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE)/sum(I(. > 0)))
  ) %>%
  pivot_longer(
    everything(),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key)))

fig_spend_action <-
  ggplot(
    df_fig_spend_action %>%
      filter(action_full %in% action_levels[1:50]),
    aes(
      x = reorder(action_full, adj_cost),
      y = adj_cost/1000
    )
  ) +
  ggtitle("Expenditures per action ($thou), by action type", "50 (of 82) most common action types") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_spend_action

```

```{r spending_act2, fig.dim = c(12, 10)}
df_fig_spend_year <-
  df_prj %>%
  group_by(project_year) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE)/ sum(n_action_prj))

fig_spend_year <-
  ggplot(
    df_fig_spend_year,
    aes(
      x = project_year,
      y = adj_cost/1000
    )
  ) +
  ggtitle("Expenditures per action ($thou), by year") +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  )
fig_spend_year
```

```{r spending_act3, fig.dim = c(12, 10)}
# Spending total, by basin ====
df_fig_spend_basin <-
  df_prj %>%
  group_by(basin) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE)/ sum(n_action_prj)) %>%
  drop_na()

fig_spend_basin <-
  ggplot(
    df_fig_spend_basin,
    aes(
      x = reorder(basin, adj_cost),
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures per action ($thou), by basin") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_spend_basin
```

```{r spending_act4, fig.dim = c(12, 10)}
# Spending total, by source ====
df_fig_spend_source <-
  df_prj %>%
  group_by(project_source) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(n_action_prj)) %>%
  drop_na()

fig_spend_source <-
  ggplot(
    df_fig_spend_source,
    aes(
      x = reorder(project_source, adj_cost),
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures per action ($thou), by source") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none"
  ) +
  coord_flip()
fig_spend_source
```

```{r spending_act5, fig.dim = c(12, 20), include = FALSE}
# Spending total, by year and action ====
df_fig_spend_year_action <-
  df_prj %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  group_by(project_year) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE)/ sum(!is.na(adj_cost)))
  ) %>%
  pivot_longer(
    starts_with("action_"),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE))

fig_spend_year_action <-
  ggplot(
    df_fig_spend_year_action %>%
      filter(action_full %in% action_levels_spend[1:18]),
    aes(
      x = project_year,
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures per action ($thou), by year and action type", "18 (of 82) action types with highest expenditures") +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5),
    strip.text = element_text(size = 8)
  ) +
  facet_wrap(~ action_fac, ncol = 3)
fig_spend_year_action
```

```{r spending_act6, fig.dim = c(12, 10)}
# Spending total, by year and basin ====
df_fig_spend_year_basin <-
  df_prj %>%
  group_by(project_year, basin) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(n_action_prj)) %>%
  drop_na() %>%
  mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE))

fig_spend_year_basin <-
  ggplot(
    df_fig_spend_year_basin %>%
      filter(basin %in% basin_levels_spend[1:12]),
    aes(
      x = project_year,
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures per action ($thou), by year and basin", "12 (of 47) basins with highest expenditures") +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  ) +
  facet_wrap(~ basin_fac, ncol = 3)
fig_spend_year_basin

```

```{r spending_act7, fig.dim = c(12, 10)}
# Spending total, by year and source ====
df_fig_spend_year_source <-
  df_prj %>%
  group_by(project_year, project_source) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(n_action_prj)) %>%
  drop_na() %>%
  mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE))

fig_spend_year_source <-
  ggplot(
    df_fig_spend_year_source %>%
      filter(project_source %in% source_levels_spend[1:8]),
    aes(
      x = project_year,
      y = adj_cost / 1000
    )
  ) +
  ggtitle("Expenditures per action ($thou), by year and source", "8 (of 38) sources with highest reported expenditures") +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#BAE4B3"
  ) +
  geom_line(
    color = "#31A354",
    size = 1
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  ) +
  facet_wrap(~ source_fac, ncol = 2)
fig_spend_year_source
```

```{r spending_act8, fig.dim = c(12, 20), include = FALSE}
# Spending total, by basin and action ====
df_fig_spend_basin_action <-
  df_prj %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  group_by(basin) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE) / sum(!is.na(adj_cost)))
  ) %>%
  pivot_longer(
    starts_with("action_"),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
  mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE))

fig_spend_basin_action <-
  ggplot(
    df_fig_spend_basin_action %>%
      filter(action_full %in% action_levels_spend[1:16]) %>%
      filter(basin %in% basin_levels_spend[1:8]),
    aes(
      x = reorder(action_full, adj_cost),
      y = adj_cost/1000
    )
  ) +
  ggtitle("Expenditures per action ($thous), by basin and action type", "16 (of 82) action types with highest expenditures in \n8 (of 47) basins with highest expenditures") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none",
    axis.text.y.left = element_text(size = 8)
  ) +
  coord_flip() +
  facet_wrap(~ basin_fac, ncol = 2)
fig_spend_basin_action
```

```{r spending_act9, fig.dim = c(12, 20), include = FALSE}
# Spending total, by source and action ====
df_fig_spend_source_action <-
  df_prj %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  group_by(project_source) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE) / sum(!is.na(adj_cost)))
  ) %>%
  pivot_longer(
    starts_with("action_"),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
  mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE))

fig_spend_source_action <-
  ggplot(
    df_fig_spend_source_action %>%
      filter(action_full %in% action_levels_spend[1:16]) %>%
      filter(project_source %in% source_levels_spend[1:8]),
    aes(
      x = reorder(action_full, adj_cost),
      y = adj_cost/1000
    )
  ) +
  ggtitle("Expenditures per action ($thous), by source and action type", "16 (of 82) action types with highest expenditures by \n8 (of 38) sources with highest expenditures") +
  geom_col(
    aes(
      fill = -adj_cost
    )
  ) +
  scale_x_discrete(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none",
    axis.text.y.left = element_text(size = 8)
  ) +
  coord_flip() +
  facet_wrap(~ source_fac, ncol = 2)
fig_spend_source_action
```


## Next Steps
1. Work on reconciling inconsistent metric structures. I'm still working on identifying different cases (especially for multiple action work sites/ projects) and coming up with reasonable ways to migrate this information to project-level data. Once this step is complete, getting descriptive information on costs per unit of action will be possible.
2. Work on calculating distance data and figuring out uses. For example, a bunch of projects seem to involve very closely clustered work sites with the same action and a shared metric value. These multiple work site projects are probably best treated as a single work site for our purposes. I've started work on writing scripts to identify such sites and possibly merge them into a single project.
3. Scope reduction? Would it be reasonable to focus on just a single basin and source? For example, Habitat Work Schedule's consistent work in the Puget Sound is quite attractive. Focusing in on a smaller region and a single source would alleviate some data inconsistency issues.