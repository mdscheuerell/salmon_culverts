---
title: "Spending and Activity for Pacific Northwest Salmon Habitat Restoration"
author: "B. Van Deynze"
date: "March 10, 2020"
output:
  html_document:
    toc: true
    toc_depth: 1
    toc_float:
      collapsed: false
---
```{css style, echo=FALSE}
# body .main-container {
#   max-width: 1944px !important;
#   # width: 1280px !important;
#   margin-left: 50px !important;
# }
# body {
#   max-width: 1944px !important;
# }
```
```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{r setup, include=FALSE}
# Set knitr options
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(fig.dim = c(10, 8))

# Clear existing environment
rm(list = ls())

# Set libraries
library(tidyverse)
library(ggplot2)
library(janitor)
library(ggthemes)
library(scales)
library(searchable)
library(kableExtra)
library(here)

# Build custom functions
# This one un-factors years (or other numerically labelled factors) while retaining their numeric values
unfactor <-
  function(x) {
    as.numeric(as.character(x))
  }

# Set ggplot2 themes
theme_set(theme_clean())
theme_update(
  plot.background = element_rect(color = NA),
  plot.title.position = "plot",
  strip.text = element_text(size = 8),
  strip.background = element_rect(fill = "grey90")
)

# Set top-level working directory
# wd <- "C:/Users/Braeden/Desktop/NOAA/Analysis"
# wd <- "D:/Braeden/OneDrive/Documents/My Work/NOAA/Analysis"
# wd <- "C:/Users/braeden.vandeynze/Documents/Salmon Cost Project/Analysis/"  # For Braeden; comment out for other users
# knitr::opts_knit$set(root.dir = wd)
```

```{r data_prep, results='hide', warning=FALSE, message=FALSE}
# Load data ====
# setwd(wd)
# setwd("./output")
df_pnshp <- read_csv(paste0(here("output"), "/PNSHP_full_working.csv"))
df_prj <- read_csv(paste0(here("output"), "/PNSHP_prj_working.csv"))

df_prj <-
  df_prj %>%
  select(
    -ends_with("_count")
  )

# Prep level lists and keys ====
# Reduce full data to action-level (removes excess rows for multiple metric actions)
df_pnshp <-
  df_pnshp %>%
  distinct(project_id, worksite_id, action, .keep_all = TRUE) %>%
  mutate(
    avail_class = ordered(avail_class, levels = c("No Costs", "Costs Available, No Metric", "Costs and Metric Available"))
  )

# Doesn't do anything but potentially useful in case of screw-ups in cleaning stage
df_prj <-
  df_prj %>%
  distinct(project_id, .keep_all = TRUE) %>%
  mutate(
    avail_class = ordered(avail_class, levels = c("No Costs", "Costs Available, No Metric", "Costs and Metric Available"))
  )

# Key for moving between action codes and full names
action_key <-
  c(
    "ESTUARY/ NEARSHORE - CHANNEL MODIFICATION" = "est_chanmod",
    "ESTUARY/ NEARSHORE - CREATION OF NEW HABITAT" = "est_create",
    "ESTUARY/ NEARSHORE - DIKE BREACHING" = "est_dikebreach",
    "ESTUARY/ NEARSHORE - DIKE RECONFIGURATION" = "est_dikereconf",
    "ESTUARY/ NEARSHORE - INVASIVE SPECIES TREATED" = "est_invasive",
    "ESTUARY/ NEARSHORE - REMOVAL OF FILL" = "est_fillrem",
    "ESTUARY/ NEARSHORE - RESTORATION OF HABITAT" = "est_resthab",
    "ESTUARY - SHORELINE ARMOR ALTERATION/REMOVAL" = "est_armormod",
    "ESTUARY - TIDEGATE ALTERATION/REMOVAL" = "est_tidegate",
    "FISH PASSAGE - BARRIERS (DAMS OR LOG JAMS)" = "fishpass_barriers",
    "FISH PASSAGE - CULVERT IMPS" = "fishpass_culvimp",
    "FISH PASSAGE - CULVERT INSTALLATION" = "fishpass_culvinst",
    "FISH PASSAGE - CULVERT REMOVAL" = "fishpass_culvrem",
    "FISH PASSAGE - DIVERSION DAM REMOVAL" = "fishpass_diverdam",
    "FISH PASSAGE - FISH LADDER IMP" = "fishpass_ladderimp",
    "FISH PASSAGE - FISH LADDER INSTALLED" = "fishpass_ladderinst",
    "FISH PASSAGE - FISHWAYS INSTALLED" = "fishpass_waysinst",
    "FISH PASSAGE - ROAD CROSSINGS IN STREAM" = "fishpass_roadcross",
    "FISH PASSAGE - WEIRS (INCOMPLETE DAMS)" = "fishpass_weirs",
    "FISH PASSAGE IMP - ROCKED FORD" = "fishpass_rockford",
    "FISH SCREENING - FISH SCREEN INSTALLED" = "screen_inst",
    "FISH SCREENING - FISH SCREEN REPLACED" = "screen_replace",
    "INSTREAM - BEAVER INTRODUCTION" = "instream_beaver",
    "INSTREAM - BOULDERS" = "instream_boulder",
    "INSTREAM - CHANNEL CONNECTIVITY" = "instream_connect",
    "INSTREAM - CHANNEL RECONFIGURATION" = "instream_reconf",
    "INSTREAM - DEFLECTORS/BARBS" = "instream_barbs",
    "INSTREAM - LARGE WOODY DEBRIS" = "instream_wooddebris",
    "INSTREAM - LOG WEIRS" = "instream_logweir",
    "INSTREAM - OFF CHANNEL HABITAT" = "instream_offchannel",
    "INSTREAM - PLANT CONTROL" = "instream_plantrem",
    "INSTREAM - PREDATOR REMOVAL" = "instream_predrem",
    "INSTREAM - ROCK WEIRS" = "instream_rockweir",
    "INSTREAM - ROOTWADS" = "instream_rootwad",
    "INSTREAM - SPAWNING GRAVEL PLACEMENT" = "instream_gravel",
    "INSTREAM - STREAMBANK STABILIZATION" = "instream_bankstab",
    "INSTREAM - LOG JAM" = "instream_logjam",
    "INSTREAM FLOW - IRRIGATION PRACTICE IMP" = "flow_irriimp",
    "INSTREAM FLOW - WATER LEASED OR PURCHASED" = "flow_waterlease",
    "LAND PROTECTED - STREAMBANK" = "land_streambank",
    "LAND PROTECTED - WETLAND OR ESTUARINE AREA" = "land_wetland",
    "NUTRIENT ENRICHMENT - CARCASS ANALOG" = "nutrient_carcanalog",
    "NUTRIENT ENRICHMENT - CARCASS PLACEMENT" = "nutrient_carcplace",
    "NUTRIENT ENRICHMENT - FERTILIZER" = "nutrient_fert",
    "PROJECT MAINTENANCE - SITE MAINTENANCE" = "projmaint_sitemaint",
    "RIPARIAN - CONSERVATION GRAZING MANAGEMENT" = "riparian_graze",
    "RIPARIAN - FENCING" = "riparian_fence",
    "RIPARIAN - FORESTRY PRACTICES/STAND MANAGEMENT" = "riparian_forest",
    "RIPARIAN - LIVESTOCK EXCLUSION" = "riparian_liveexcl",
    "RIPARIAN - LIVESTOCK WATER DEVELOPMENT" = "riparian_livewater",
    "RIPARIAN - PLANTING" = "riparian_plant",
    "RIPARIAN - WATER GAP DEVELOPMENT" = "riparian_watergap",
    "RIPARIAN - WEED CONTROL" = "riparian_weed",
    "SED REDUCTION - EROSION CONTROL STRUCTURES" = "sedireduce_contstruc",
    "SED REDUCTION - ROAD DRAINAGE SYSTEM IMPS" = "sedireduce_roaddrain",
    "SED REDUCTION - ROAD OBLITERATION" = "sedireduce_roadobli",
    "SED REDUCTION - ROAD RECONSTRUCTION" = "sedireduce_roadrecon",
    "SED REDUCTION - ROAD RELOCATION" = "sedireduce_roadrelo",
    "SED REDUCTION - ROAD STREAM CROSSING IMPS" = "sedireduce_roadcross",
    "SED REDUCTION - SED CONTROL" = "sedireduce_sedicont",
    "UPLAND AGRICULTURE - BMP/AGRICULTURE MANAGEMENT" = "agri_mgmt",
    "UPLAND AGRICULTURE - BMP/STRUCTURAL PRACTICES" = "agri_structure",
    "UPLAND AGRICULTURE - BMP/VEG AND TILLING PRACTICES" = "agri_tillage",
    "LIVESTOCK - EXCLUSION OR FENCING" = "livestock_fence",
    "LIVESTOCK - GRAZING MANAGEMENT" = "livestock_graze",
    "LIVESTOCK - WATER DEVELOPMENT" = "livestock_water",
    "UPLAND VEG - INVASIVE CONTROL" = "uplandveg_invasive",
    "UPLAND VEG - PLANTING" = "uplandveg_plant",
    "UPLAND VEG - SLOPE STABILIZATION" = "uplandveg_slope",
    "UPLAND VEG - STAND MANAGEMENT" = "uplandveg_standmgmt",
    "WATER QUALITY IMP - MANURE MANAGEMENT" = "wqimp_manure",
    "WATER QUALITY IMP - REFUSE REMOVAL" = "wqimp_refuse",
    "WATER QUALITY IMP - RETURN FLOW COOLING" = "wqimp_flowcool",
    "WATER QUALITY IMP - SEWAGE CLEAN-UP" = "wqimp_sewage",
    "WATER QUALITY IMP - WASTEWATER" = "wqimp_wastewater",
    "WATER QUALITY IMP - TOXIC CLEAN-UP" = "wqimp_toxic",
    "WETLAND - PLANT CONTROL" = "wetland_plantrem",
    "WETLAND - PLANTING" = "wetland_plant",
    "WETLAND - CREATION" = "wetland_create",
    "WETLAND - IMP" = "wetland_imp",
    "WETLAND - INVASIVE REMOVAL" = "wetland_invasive",
    "WETLAND - RESTORATION" = "wetland_restore"
  )

# Pull and sort labels for ordered factors used in facets
action_levels <-
  df_pnshp %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  tabyl(action_full) %>%
  arrange(-n) %>%
  pull(action_full)

basin_levels <-
  df_pnshp %>%
  tabyl(basin) %>%
  arrange(-n) %>%
  pull(basin)

source_levels <-
  df_pnshp %>%
  tabyl(project_source) %>%
  arrange(-n) %>%
  pull(project_source)

basin_levels_prj <-
  df_prj %>%
  tabyl(basin) %>%
  arrange(-n) %>%
  pull(basin)

source_levels_prj <-
  df_prj %>%
  tabyl(project_source) %>%
  arrange(-n) %>%
  pull(project_source)

action_levels_spend <-
  df_prj %>%
  filter(adj_cost < 50000000) %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(~ .*adj_cost)
  ) %>%
  summarize_at(
    vars(starts_with("action_")),
    list(~sum(., na.rm = TRUE))
  ) %>%
  pivot_longer(
    everything(),
    names_to = "action",
    names_prefix = "action_",
    values_to = "adj_cost"
  ) %>%
  mutate(action_full = recode(action, !!!invert(action_key))) %>%
  arrange(-adj_cost) %>%
  pull(action_full)

basin_levels_spend <-
  df_prj %>%
  group_by(basin) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
  arrange(-adj_cost) %>%
  pull(basin)

source_levels_spend <-
  df_prj %>%
  group_by(project_source) %>%
  summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
  arrange(-adj_cost) %>%
  pull(project_source)
```
This document is intended as a primer on the Pacific Northwest Salmonoid Habitat Projects (PNSHP) database, with a focus on the availability of project costs. The primary goal of this report is to evaluate the usefulness of the data for modeling habitat restoration costs. We begin by discussing the extent, structure, and origin of the PNSHP data. We then explore where, when, and what is reported in the data through a series of figures. Along the way, we highlight opprotunities to dig deeper or focus future analysis.

# Data Background
The PNSHP data set brings together data on habitat restoration actions related directly or indirectly to salmonoid habitat in Oregon, Washington, Idaho, and Montana. *Actions* are categorized in to one of 82 action types and grouped by a geo-coded *work site*. Work sites are further grouped by *project*. Project-level information is available on the *source* (who reported the project, often a funder or another database) and *expenditures*. For many projects, information on the *extent* of the action taken (e.g. length of stream or road treated, area treated) is also available, though how this information is structured varies widely by action-type, source, and project complexity.

In this document, we include projects **between 1991 and 2015** (25 years). During this period, the number of ESA-listed salmon Evolutionarily Significant Units (ESUs) grew from zero to 19 (including steelhead). The first listing was Snake River sockeye, listed as endangered in 1991. The most recent listing was the Oregon coast coho, listed as threatened in 2008. This period also covers major changes in available financing for the habitat projects. A major population boom in the region, especially in the Puget Sound basin, increased the tax base for state-funded projects (while simultaneously increasing pressure on salmon habitat via development and water demands). The financial crisis of 2008 also lead to funding cuts across government agencies. Projects are added to the database in batches in a rolling fashion, so far fewer projects are reported in the most recent years. To accommodate for this, I include only projects up to 2015.

I have also removed a handful of projects that are extreme outliers in either cost or number or work sites. Only projects with **costs less than $50mill** and with **fewer than 50 work sites** are included.

## Project Structure Typology
Due to differences in how projects are funded, organized, and reported across sources, project data are structured in different ways. Some projects are quite complex, spanning dozens work sites miles apart with different actions at each. Some are simple, consisting of a single action at a single work site. Many are in-between, consisting of a handful of work site with the same action or a single work site with many actions.

To make matters more complex, *project costs* (i.e. expenditures) are always reported at the project level (rather than the action or work site level), while it appears that *metrics* (i.e. extent of action) are sometimes reported at the project level, sometimes at the work site level, and sometimes at the individual action level. This makes directly comparing average costs (i.e. expenditures per unit) between projects difficult.

Below, I present a typology of projects based on their structure. I distinguish between the number of work sites and the number of action types. From there, I further breakdown each category by whether costs and metrics are available, costs only are available, or no costs are available (metrics without costs are not useful for the purpose of modeling costs).

The majority of projects fall into either the single work site, single action type category. Among multiple work site projects, the majority fall into the single action type category, which will greatly simplify subsequent analysis. For multiple action type projects, directly modeling average costs will be difficult, as distinguishing between spending on different action types is impossible. One approach may be to model individual actions and use multiple action type projects as a check, using single action type model results to project expected costs for multiple action type projects and compare projected and observed total project costs between the two.

For projects where costs are available but not metrics, all is not lost. We could consider a more general model of costs at the project level, where the number of distinct actions, the total number of actions, or which types of actions, and the number of work sites are considered as covariates. This kind of model could inform decisions on project structure. Are more complex projects more expensive than simpler projects? Or do scale effects swamp increased costs due to complexity?

```{r typology, include = FALSE}
# All projects
n_projects <-
  df_prj %>%
  pull(project_id) %>%
  n_distinct() %>%
  comma()

# Single worksites
n_single <-
  df_prj %>% filter(n_worksites == 1) %>%
  pull(project_id) %>%
  n_distinct() %>%
  comma()

# Single worksites, single action type
n_single_single <-
  df_prj %>% filter(n_worksites == 1) %>%
  filter(n_action_prj_dist == 1) %>%
  pull(project_id) %>%
  n_distinct() %>%
  comma()

# Single worksites, single action type, cost/metric breakdown
n_single_single_costmetric <-
  df_prj %>% filter(n_worksites == 1) %>%
  filter(n_action_prj_dist == 1) %>%
  group_by(avail_class) %>%
  count() %>%
  deframe() %>%
  comma()

# Single worksites, multi action type
n_single_multi <-
  df_prj %>% filter(n_worksites == 1) %>%
  filter(n_action_prj_dist > 1) %>%
  pull(project_id) %>%
  n_distinct() %>%
  comma()

# Single worksites, multi action type, cost/metric breakdown
n_single_multi_costmetric <-
  df_prj %>% filter(n_worksites == 1) %>%
  filter(n_action_prj_dist > 1) %>%
  group_by(avail_class) %>%
  count() %>%
  deframe() %>%
  comma()

# Multi worksite
n_multi <-
  df_prj %>%
  filter(n_worksites > 1) %>%
  pull(project_id) %>%
  n_distinct() %>%
  comma()

# Multi worksite, single action type
n_multi_single <-
  df_prj %>%
  filter(n_worksites > 1) %>%
  filter(n_action_prj_dist == 1) %>%
  pull(project_id) %>%
  n_distinct() %>%
  comma()

# Multi worksite, single action type, cost/metric breakdown
n_multi_single_costmetric <-
  df_prj %>%
  filter(n_worksites > 1) %>%
  filter(n_action_prj_dist == 1) %>%
  group_by(avail_class) %>%
  count() %>%
  deframe() %>%
  comma()

# Multi worksite, multi action type
n_multi_multi <-
  df_prj %>%
  filter(n_worksites > 1) %>%
  filter(n_action_prj_dist > 1) %>%
  pull(project_id) %>%
  n_distinct() %>%
  comma()

# Multi worksite, multi action type, cost/metric breakdown
n_multi_multi_costmetric <-
  df_prj %>%
  filter(n_worksites > 1) %>%
  filter(n_action_prj_dist > 1) %>%
  group_by(avail_class) %>%
  count() %>%
  deframe() %>%
  comma()
```

<blockquote>
<b>All projects</b> (n = `r n_projects`)
<ul>
    <li>Single work site (n = `r n_single`)
        <ul>
            <li>Single action type (n = `r n_single_single`)
                <ul>
                    <li>Costs and metrics available (n = `r n_single_single_costmetric[[3]]`)</li>
                    <li>Costs only (n = `r n_single_single_costmetric[[2]]`)</li>
                    <li>Costs unavailable (n = `r n_single_single_costmetric[[1]]`)</li>
                </ul>
            </li>
            <li>Multiple action types (n = `r n_single_multi`)
                <ul>
                    <li>Costs and metrics available (n = `r n_single_multi_costmetric[[3]]`)</li>
                    <li>Costs only (n = `r n_single_multi_costmetric[[2]]`)</li>
                    <li>Costs unavailable (n = `r n_single_multi_costmetric[[1]]`)</li>
                </ul>
            </li>    
        </ul>
    </li>
    <li>Multiple work sites (n = `r n_multi`)
        <ul>
            <li>Single action type (n = `r n_multi_single`)
                <ul>
                    <li>Costs and metrics available (n = `r n_multi_single_costmetric[[3]]`)</li>
                    <li>Costs only (n = `r n_multi_single_costmetric[[2]]`)</li>
                    <li>Costs unavailable (n = `r n_multi_single_costmetric[[1]]`)</li>
                </ul>
            </li>    
            <li>Multiple action types (n = `r n_multi_multi`)
                <ul>
                    <li>Costs and metrics available (n = `r n_multi_multi_costmetric[[3]]`)</li>
                    <li>Costs only (n = `r n_multi_multi_costmetric[[2]]`)</li>
                    <li>Costs unavailable (n = `r n_multi_multi_costmetric[[1]]`)</li>
                </ul>
            </li>
        </ul>
    </li>
</ul>
</blockquote>

## Source Glossary
Thirty-eight different organizations, referred to as *sources*, contribute data to PNSHP. Below you will find a glossary of each source code.

>
**ASOTIN** - Asotin County Conservation District (Asotin County is the southeastern-most county in Washington and contains important Snake River watersheds)  
**BLM** - Bureau of Land Management  
**BOR** - Bureau of Reclamation (Department of the Interior agency responsible for water storage and irrigation, including federal dams)  
**BPA** - Bonneville Power Administration  
**CBFWA** - Columbia Basin Fish and Wildlife Authority (Now defunct group of state, federal, and tribal agencies organized to advise BPA on habitat improvement efforts)  
**CHEHALIS** - Chehalis Tribe (Southwestern Washington)  
**COLVILLE** - Colville Tribe (Northeastern Washington)  
**COQUILLE** - Coquille Tribe (Southwestern Oregon)  
**COWLITZ** -  Cowlitz Tribe (Northeastern Washington)  
**CRITFC** - Columbia River Inter-Tribal Fisheries Commission  
**DUCKS UNLIMITED** - Ducks Unlimited  
**FISHER FISHERIES** - Fisher Fisheries Consultancy  
**GRAND RONDE** - Grand Ronde Tribe (Central Western Oregon)  
**GRMWP** - Grande Ronde Model Watershed Program (Northeastern Oregon river)  
**HABITAT WORK SCHEDULE** - Washington State program for tracking projects by the 27 "Lead Entities", local boards responsible for managing state salmon habitat spending
**ID OSC** - Idaho Office of Species Conservation  
**IDAHODEQ** - Idaho Department of Environmental Quality  
**IDFG** - Idaho Department of Fish and Game  
**IDFG SCREEN SHOP** - Fish screen efforts for IDFG  
**KRITFWC** - Klamath River Inter-Tribal Fish and Water Commission (Southern Oregon river)  
**MONTANA WATER CENTER** - Research institute  based at Montana State  
**NMFS** - NOAA Fisheries  
**NOAA RESTORATION** - NOAA Restoration Center  
**NRRSS** - National River Restoration Science Synthesis project (a project of American Rivers)  
**NWIFC** - Northwest Indian Fisheries Commission  
**OR WATER TRUST** - Oregon Water Trust  
**OWRI** - Oregon Watershed Restoration Inventory  
**PCSRF** - Pacific Coastal Salmon Recovery Fund (federal grant program administered by NOAA)  
**REO** - United States Forest Service Region 6 Regional Ecosystem Office  
**SHOSHONE-BANNOCK** - Shoshone-Bannock Tribes (Southeastern Idaho)  
**SRFBD** - Salmon Funding Recovery Board Database (Washington State Recreation and Conservation Office grant program)  
**STREAMNET** - Data project of the Pacific States Marine Fisheries Commission  
**WA DOE** - Washington State Department of Ecology  
**WA RCO** - Washington State Recreation and Conservation Office  
**WA WATER TRUST** - Washington Water Trust  
**WDFW FISHWAY** - Washington State Department of Fish and Wildlife (WDFW) Fish way Program  
**WDFW WRIP** - WDFW Watershed Recovery Inventory Project  
**WDOT** - Washington Department of Transportation

```{r figsprep_base, include = FALSE}
# Build base figures ====

# Base bar plot for counts with costs
base_countcost_bar <-
  ggplot(df_pnshp, aes(y = n, fill = avail_class, group = avail_class)) +
  geom_col() +
  scale_x_discrete(
    name = NULL,
    labels = wrap_format(45)
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_brewer("Costs/Metric Reported", palette = "Greens") +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 9, vjust = 0.5),
    legend.title = element_text(size = 9),
    legend.background = element_rect(size = 0.5),
    legend.key.size = unit(0.4, "cm"),
    axis.text.y = element_text(size = 9)
  )

# Base line plot for counts with costs
base_countcost_line <-
  ggplot(
    df_pnshp,
    aes(
      x = completed_year,
      y = n,
      fill = avail_class,
      group = avail_class
    )
  ) +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area() +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = "Count",
    labels = label_comma()
  ) +
  scale_fill_brewer("Costs/Metric Reported", palette = "Greens") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5),
    legend.position = "bottom",
    legend.text = element_text(size = 9, vjust = 0.5),
    legend.title = element_text(size = 9),
    legend.background = element_rect(size = 0.5),
    legend.key.size = unit(0.4, "cm")
  )

# Base bar plot for costs
base_cost_bar <-
  ggplot(
    df_prj,
    aes(
      y = adj_cost/1000
    )
  ) +
  geom_col(
    aes(
      fill = -log(adj_cost)
    )
  ) +
  scale_x_discrete(
    name = NULL,
    labels = wrap_format(45)
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma(),
    position = "right"
  ) +
  scale_fill_distiller(palette = "YlGn") +
  theme(
    legend.position = "none",
    axis.text.x = element_text(size = 9)
  ) +
  coord_flip()

# Base line plot for costs
base_cost_line <-
  ggplot(
    df_prj,
    aes(
      x = completed_year,
      y = adj_cost/1000
    )
  ) +
  geom_vline(
    xintercept = seq(1990, 2015, 5),
    alpha = 0.5,
    linetype = "dashed"
  ) +
  geom_area(
    fill = "#A1D99B"
  ) +
  scale_x_continuous(
    name = NULL
  ) +
  scale_y_continuous(
    name = NULL,
    labels = label_comma()
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  )
```

# Action and Project Counts {#count-top}
In this section, I visualize the number of actions in the PNSHP data set by (a) action type, (b) year, (c) basin, and (d) source (and cross-tabulations). Counts of projects are also presented by (a) year, (b) basin, and (c) source (and cross-tabulations). These figures illustrate trends in project and action quantity over time and differences in actions taken across space, while also highlighting potential differences in reporting across different sources and regions.

I also include a breakdown of project cost and metric availability to demonstrate where there might be opportunities to reliably model costs and highlight potential data gaps. In order to calculate figures like "cost per acre treated" or "cost per stream mile", both cost and metric will be needed.

## Count Figures {.tabset .tabset-fade .tabset-pills}

### Counts of Actions {.tabset .tabset-fade .tabset-pills}
```{r figbuild_action, include = FALSE}
# Action counts w/ costs ====
# By type
fig_countcost_type <-
  base_countcost_bar %+%
  (df_pnshp %>%
     group_by(action, avail_class) %>%
     summarize(n = n()) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     filter(action_full %in% action_levels[1:50])
  ) +
  aes(
    x = reorder(action_full, n)
  ) +
  ggtitle("Action count, by action type", "50 (of 82) most common action types")

# By year
fig_countcost_year <-
  base_countcost_line %+%
  (df_pnshp %>%
     group_by(completed_year = ordered(completed_year), avail_class, .drop = FALSE) %>%
     count() %>%
     ungroup() %>%
     mutate(
       completed_year = unfactor(completed_year)
     )
  ) +
  ggtitle("Action count, by year")

# By basin
fig_countcost_basin <-
  base_countcost_bar %+%
  (df_pnshp %>%
     group_by(basin, avail_class) %>%
     summarize(n = n()) %>%
     mutate(basin_fac = factor(basin, basin_levels, ordered = TRUE)) %>%
     filter(!is.na(basin))
  ) +
  aes(
    x = reorder(basin, n)
  ) +
  ggtitle("Action count, by basin")

# By source
fig_countcost_source <-
  base_countcost_bar %+%
  (df_pnshp %>%
     group_by(project_source, avail_class) %>%
     summarize(n = n()) %>%
     mutate(source_fac = factor(project_source, source_levels, ordered = TRUE)) %>%
     filter(!is.na(project_source))
  ) +
  aes(
    x = reorder(project_source, n)
  ) +
  ggtitle("Action count, by source")

# By year and type
fig_countcost_year_type <-
  base_countcost_line %+%
  (df_pnshp %>%
     group_by(action = factor(action), completed_year = ordered(completed_year), avail_class = factor(avail_class), .drop = FALSE) %>%
     count() %>%
     ungroup() %>%
     mutate(
       completed_year = unfactor(completed_year)
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     mutate(action_fac = factor(action_full, action_levels, ordered = TRUE)) %>%
     filter(action_full %in% action_levels[1:16])
  ) +
  ggtitle("Action count, by year and action type", "16 (of 82) most common action types") +
  facet_wrap(~ action_fac, ncol = 4, labeller = label_wrap_gen(width = 25))

# By basin and type
fig_countcost_basin_type <-
  base_countcost_bar %+%
  (df_pnshp %>%
     group_by(action, basin, avail_class) %>%
     summarize(n = n()) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     mutate(action_fac = factor(action_full, action_levels, ordered = TRUE)) %>%
     mutate(basin_fac = factor(basin, basin_levels, ordered = TRUE)) %>%
     filter(
       action_full %in% action_levels[1:16]
     ) %>%
     filter(
       basin %in% basin_levels[1:10]
     )
  ) +
  aes(
    x = reorder(action_full, n)
  ) +
  ggtitle("Action count, by basin and type", "16 (of 82) most common action types in 10 (of 47) basins with most actions") +
  facet_wrap(~ basin_fac, ncol = 2, labeller = label_wrap_gen(width = 25))


# By source and type
fig_countcost_source_type <-
  base_countcost_bar %+%
  (df_pnshp %>%
     group_by(action, project_source, avail_class) %>%
     summarize(n = n()) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     mutate(action_fac = factor(action_full, action_levels, ordered = TRUE)) %>%
     mutate(source_fac = factor(project_source, source_levels, ordered = TRUE)) %>%
     filter(
       action_full %in% action_levels[1:12]
     ) %>%
     filter(
       project_source %in% source_levels[1:16]
     )
  ) +
  aes(
    x = reorder(action_full, n)
  ) +
  ggtitle("Action count, by source and type", "12 (of 82) most common action types by 16 sources (of 38) with most actions; note X-axis varies by source") +
  facet_wrap(~ source_fac, scales = "free_x", ncol = 4, labeller = label_wrap_gen(width = 25))

# By source and year
fig_countcost_source_year <-
  base_countcost_line %+%
  (df_pnshp %>%
     group_by(completed_year = ordered(completed_year, levels = 1991:2015), avail_class = factor(avail_class), project_source = factor(project_source), .drop = FALSE) %>%
     count() %>%
     ungroup() %>%
     complete(project_source, completed_year, avail_class, fill = list(`n()` = 0)) %>%
     mutate(
       completed_year = unfactor(completed_year)
     ) %>%
     mutate(source_fac = factor(project_source, source_levels, ordered = TRUE)) %>%
     filter(
       project_source %in% source_levels[1:12]
     )
  ) +
  ggtitle("Action count, by source and year", "12 sources (of 38) with most actions") +
  facet_wrap(~ source_fac, ncol = 4, labeller = label_wrap_gen(width = 25))

# By basin and year
fig_countcost_basin_year <-
  base_countcost_line %+%
  (df_pnshp %>%
     group_by(completed_year = ordered(completed_year), basin = factor(basin), avail_class, .drop = FALSE) %>%
     count() %>%
     ungroup() %>%
     mutate(
       completed_year = unfactor(completed_year)
     ) %>%
     mutate(basin_fac = factor(basin, basin_levels, ordered = TRUE)) %>%
     filter(
       basin %in% basin_levels[1:12]
     )
  ) +
  ggtitle("Action count, by basin and year", "12 basins (of 47) with most actions") +
  facet_wrap(~ basin_fac, ncol = 4, labeller = label_wrap_gen(width = 25))

# By basin and funding
fig_countcost_basin_source <-
  base_countcost_bar %+%
  (df_pnshp %>%
     group_by(project_source, basin, avail_class) %>%
     summarize(n = n()) %>%
     mutate(source_fac = factor(project_source, source_levels, ordered = TRUE)) %>%
     mutate(basin_fac = factor(basin, basin_levels, ordered = TRUE)) %>%
     filter(
       project_source %in% source_levels[1:12]
     ) %>%
     filter(
       basin %in% basin_levels[1:10]
     )
  ) +
  aes(
    x = reorder(basin, n)
  ) +
  ggtitle("Action count, by basin and funding source", "10 basins (of 47) and 12 sources (of 38) with most actions") +
  facet_wrap(~ source_fac, ncol = 4, labeller = label_wrap_gen(width = 25))
```
#### By Year
>**Observation:** Both the number of projects and the number of actions peak in the early '00s. The number of actions and projects collapses during the recession, likely due to a lack of funding. The number of projects per year does not recover to pre-recession levels, while the number of actions does see a bump in the early '10s, indicating an increase in the number of actions reported per project.

```{r figs_counts_byyear}
fig_countcost_year
fig_countcost_basin_year
fig_countcost_source_year
```
```{r figs_counts_byyear2, fig.dim = c(10,12)}
fig_countcost_year_type
```
\
[Back to top](#count-top)

#### By Action Type
>**Observation:** Road drainage system improvements are by far the most common actions. Most of these actions occurred between 1995 and 2005 in Western Oregon (Willamette, Southern Oregon Coastal, and Northern Oregon Coastal basins), and are reported through the Oregon Watershed Restoration Inventory (OWRI). Road obliterations follow a similar pattern. These actions are the fifth mos common, are also concentrated in Western Oregon during the same period, and are mostly reported through OWRI.
\

>**Observation:** Culvert-related projects (upgrades and removals) are quite common and consistently reported over time and space. The reporting of culvert projects does not follow the pattern of Oregon roadwork projects and is more widespread over several basins and reporting sources.
\

>**Observation:** More direct habitat improvements like plantings, stream-flow alterations (e.g. large woody debris, boulders, log jams, etc.), and weeding are widely and consistently documented. These sorts of actions might be directly comparable in terms of costs.

```{r figs_counts_byaction, fig.dim = c(10,12)}
fig_countcost_type
fig_countcost_year_type
fig_countcost_basin_type
fig_countcost_source_type
```
\
[Back to top](#count-top)

#### By Basin
```{r figs_counts_bybasin}
fig_countcost_basin
fig_countcost_basin_year
fig_countcost_basin_source
```
```{r figs_counts_bybasin2, fig.dim = c(10,12)}
fig_countcost_basin_type
```
\
[Back to top](#count-top)

#### By Reporting Source
>**Observation:** Livestock (including riparian fencing) and upland actions are common, but mainly reported by Bureau of Land Management (BLM). These actions are likely more targeted towards general watershed improvements rather than salmon habitat in particular.

```{r figs_counts_bysource}
fig_countcost_source
fig_countcost_source_year
fig_countcost_basin_source
```
```{r figs_counts_bysource2, fig.dim = c(10,12)}
fig_countcost_source_type
```
\
[Back to top](#count-top)

```{r figsremove_action, include = FALSE}
rm(
  fig_countcost_basin_source,
  fig_countcost_basin,
  fig_countcost_basin_type,
  fig_countcost_basin_year,
  fig_countcost_source,
  fig_countcost_source_type,
  fig_countcost_source_year,
  fig_countcost_type,
  fig_countcost_year,
  fig_countcost_year_type
)
```

### Counts of Projects {.tabset .tabset-fade .tabset-pills}
```{r figsbuild-prj, include = FALSE}
# Project count w/ costs ====
# By year
fig_prjcost_year <-
  base_countcost_line %+%
  (df_prj %>%
     group_by(completed_year = ordered(completed_year), avail_class, .drop = FALSE) %>%
     count() %>%
     ungroup() %>%
     mutate(
       completed_year = unfactor(completed_year)
     )
  ) +
  ggtitle("Project count, by year")

# By basin
fig_prjcost_basin <-
  base_countcost_bar %+%
  (df_prj %>%
     group_by(basin, avail_class) %>%
     summarize(n = n()) %>%
     mutate(basin_fac = factor(basin, basin_levels_prj, ordered = TRUE)) %>%
     filter(!is.na(basin))
  ) +
  aes(
    x = reorder(basin, n)
  ) +
  ggtitle("Project count, by basin")

# By source
fig_prjcost_source <-
  base_countcost_bar %+%
  (df_prj %>%
     group_by(project_source, avail_class) %>%
     summarize(n = n()) %>%
     mutate(source_fac = factor(project_source, source_levels_prj, ordered = TRUE)) %>%
     filter(!is.na(project_source))
  ) +
  aes(
    x = reorder(project_source, n)
  ) +
  ggtitle("Project count, by source")

# By source and year
fig_prjcost_source_year <-
  base_countcost_line %+%
  (df_prj %>%
     group_by(completed_year = ordered(completed_year), avail_class = factor(avail_class), project_source = factor(project_source), .drop = FALSE) %>%
     count() %>%
     ungroup() %>%
     mutate(
       completed_year = unfactor(completed_year)
     ) %>%
     mutate(source_fac = factor(project_source, source_levels_prj, ordered = TRUE)) %>%
     filter(
       project_source %in% source_levels_prj[1:12]
     )
  ) +
  ggtitle("Project count, by source and year", "12 sources (of 38) with most actions") +
  facet_wrap(~ source_fac, ncol = 4, labeller = label_wrap_gen(width = 25))

# By basin and year
fig_prjcost_basin_year <-
  base_countcost_line %+%
  (df_prj %>%
     group_by(completed_year = ordered(completed_year), basin = factor(basin), avail_class = factor(avail_class), .drop = FALSE) %>%
     count() %>%
     ungroup() %>%
     mutate(
       completed_year = unfactor(completed_year)
     ) %>%
     mutate(basin_fac = factor(basin, basin_levels_prj, ordered = TRUE)) %>%
     filter(
       basin %in% basin_levels_prj[1:12]
     )
  ) +
  ggtitle("Project count, by basin and year", "12 basins (of 47) with most actions") +
  facet_wrap(~ basin_fac, ncol = 4, labeller = label_wrap_gen(width = 25))

# By basin and funding
fig_prjcost_basin_source <-
  base_countcost_bar %+%
  (df_prj %>%
     group_by(project_source, basin, avail_class) %>%
     summarize(n = n()) %>%
     mutate(source_fac = factor(project_source, source_levels_prj, ordered = TRUE)) %>%
     mutate(basin_fac = factor(basin, basin_levels_prj, ordered = TRUE)) %>%
     filter(
       project_source %in% source_levels_prj[1:12]
     ) %>%
     filter(
       basin %in% basin_levels_prj[1:10]
     )
  ) +
  aes(
    x = reorder(basin, n)
  ) +
  ggtitle("Project count, by basin and source", "10 basins (of 47) and 12 reporting sources (of 38) with most actions") +
  facet_wrap(~ source_fac, ncol = 4, labeller = label_wrap_gen(width = 25))
```

#### By Year
```{r figs_proj_byyear}
fig_prjcost_year
fig_prjcost_basin_year
fig_prjcost_source_year
```
\
[Back to top](#count-top)

#### By Basin
```{r figs_proj_bybasin}
fig_prjcost_basin
fig_prjcost_basin_year
fig_prjcost_basin_source
```
\
[Back to top](#count-top)

#### By Reporting Source
```{r figs_proj_bysource}
fig_prjcost_source
fig_prjcost_source_year
fig_prjcost_basin_source
```
\
[Back to top](#count-top)

```{r figsremove_proj, include = FALSE}
rm(
  fig_prjcost_source,
  fig_prjcost_source_year,
  fig_prjcost_basin_source,
  fig_prjcost_basin,
  fig_prjcost_basin_year,
  fig_prjcost_year
)
```

# Expenditures {#expend-top}
```{r spending_calcs, include = FALSE}
total_expenditures <- df_prj %>% pull(adj_cost) %>% sum(na.rm = TRUE) %>% format(big.mark = ",")
avail_expenditures_count <- df_prj %>% pull(adj_cost) %>% is.na() %>% sum(na.rm = TRUE)
avail_expenditures_count <- nrow(df_prj) - avail_expenditures_count
avail_expenditures_pct <- ((avail_expenditures_count / nrow(df_prj)) * 100) %>% format(digits = 3)
```
In this section, I visualize reported expenditures over (a) action type, (b) year, (c) basin, and (d) source (and selected cross-tabulations). Note that a single project will fall into multiple action type categories if the project consists of multiple action types. All expenditures are converted to 2019 dollars via FRED Implicit Price Deflator. Three projects were removed as outliers in their spending levels (see note below).

Expenditures are available for `r format(avail_expenditures_count, big.mark = ",")` projects, or `r avail_expenditures_pct`% of `r format(nrow(df_prj), big.mark = ",")` projects. In total, the PNSHP data set reports \$`r total_expenditures` in expenditures across all 25 years.

<!-- ## Observations -->
<!-- UPDATE ME -->
<!-- 1. When I first ran these, there was a crazy peak in spending in the Willamette basin in 1991. Further investigation reveals that this is due to two projects reported in the Willamette by NRRSS in 1991. Both projects are involve "Water Quality Improvement - Return Flow Cooling", and one involves fish screen installation. The more expensive of the two cost over \$110 million while the other cost just shy of \$64 million. These two return flow cooling projects are two of only 21 projects reported that involve this action type. A third 1997 NRRSS-reported toxic water clean-up project in the Pend Orielle basin has a reported cost of around \$54 million. The next most expensive project has a reported cost of only $14 million. Given their outlier status, these NRRSS projects will be removed from future analysis. -->

## Expenditures Figures {.tabset .tabset-fade .tabset-pills}

For figures that break down expenditures by action type, note that these are expenditures on ***projects*** that include ***at least one instance*** of that action type. That is, expenditures per action under the *INSTREAM - LARGE WOODY DEBRIS* action type would be expenditures per action for *projects* that include that action type as opposed to expenditures per action of that action type. For projects with multiple action types, we cannot distinguish between spending on each action type.

### Total {.tabset .tabset-fade .tabset-pills}
```{r figsbuild_spend, include = FALSE}
# Spending totals ====
# By action
fig_spend_action <-
  base_cost_bar %+%
  (df_prj %>%
     ungroup() %>%
     mutate_at(
       vars(starts_with("action_")),
       as.numeric
     ) %>%
     mutate_at(
       vars(starts_with("action_")),
       list(~ .*adj_cost)
     ) %>%
     summarize_at(
       vars(starts_with("action_")),
       list(~sum(., na.rm = TRUE))
     ) %>%
     pivot_longer(
       everything(),
       names_to = "action",
       names_prefix = "action_",
       values_to = "adj_cost"
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     filter(action_full %in% action_levels[1:50])
  ) +
  aes(
    x = reorder(action_full, adj_cost)
  ) +
  ggtitle("Expenditures ($thou), by action type", "50 (of 82) most common action types")

# By year
fig_spend_year <-
  base_cost_line %+%
  (df_prj %>%
     group_by(completed_year) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE))
  ) +
  ggtitle("Expenditures ($thou), by year")

# By basin
fig_spend_basin <-
  base_cost_bar %+%
  (df_prj %>%
     group_by(basin) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
     drop_na()
  ) +
  aes(
    x = reorder(basin, adj_cost)
  ) +
  ggtitle("Expenditures ($thou), by basin")

# By source
fig_spend_source <-
  base_cost_bar %+%
  (df_prj %>%
     group_by(project_source) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
     drop_na()
  ) +
  aes(
    x = reorder(project_source, adj_cost)
  ) +
  ggtitle("Expenditures ($thou), by source")

# By year and action
fig_spend_year_action <-
  base_cost_line %+%
  (df_prj %>%
     ungroup() %>%
     mutate_at(
       vars(starts_with("action_")),
       as.numeric
     ) %>%
     mutate_at(
       vars(starts_with("action_")),
       list(~ .*adj_cost)
     ) %>%
     group_by(completed_year) %>%
     summarize_at(
       vars(starts_with("action_")),
       list(~sum(., na.rm = TRUE))
     ) %>%
     pivot_longer(
       starts_with("action_"),
       names_to = "action",
       names_prefix = "action_",
       values_to = "adj_cost"
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
     filter(action_full %in% action_levels_spend[1:18])
  ) +
  ggtitle("Expenditures ($thou), by year and action type", "18 (of 82) action types with highest expenditures") +
  theme(
    strip.text = element_text(size = 8)
  ) +
  facet_wrap(~ action_fac, ncol = 3, labeller = label_wrap_gen(width = 25))

# By year and basin
fig_spend_year_basin <-
  base_cost_line %+%
  (df_prj %>%
     group_by(completed_year, basin) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
     drop_na() %>%
     mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE)) %>%
     filter(basin %in% basin_levels_spend[1:12])
  ) + 
  ggtitle("Expenditures ($thou), by year and basin", "12 (of 47) basins with highest expenditures") +
  facet_wrap(~ basin_fac, ncol = 3, labeller = label_wrap_gen(width = 25))

# By year and source
fig_spend_year_source <-
  base_cost_line %+%
  (df_prj %>%
     group_by(completed_year, project_source) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
     drop_na() %>%
     mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE)) %>%
     filter(project_source %in% source_levels_spend[1:8])
  ) +
  ggtitle("Expenditures ($thou), by year and source", "8 (of 38) sources with highest reported expenditures") +
  facet_wrap(~ source_fac, ncol = 2, labeller = label_wrap_gen(width = 25))

# By basin and action
fig_spend_basin_action <-
  base_cost_bar %+%
  (df_prj %>%
     ungroup() %>%
     mutate_at(
       vars(starts_with("action_")),
       as.numeric
     ) %>%
     mutate_at(
       vars(starts_with("action_")),
       list(~ .*adj_cost)
     ) %>%
     group_by(basin) %>%
     summarize_at(
       vars(starts_with("action_")),
       list(~sum(., na.rm = TRUE))
     ) %>%
     pivot_longer(
       starts_with("action_"),
       names_to = "action",
       names_prefix = "action_",
       values_to = "adj_cost"
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
     mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE))  %>%
     filter(action_full %in% action_levels_spend[1:16]) %>%
     filter(basin %in% basin_levels_spend[1:8])
  ) +
  aes(
    x = reorder(action_full, adj_cost)
  ) +
  ggtitle("Expenditures ($thous), by basin and action type", "16 (of 82) action types with highest expenditures in \n8 (of 47) basins with highest expenditures") +
  facet_wrap(~ basin_fac, ncol = 2, labeller = label_wrap_gen(width = 25))

# By source and action
fig_spend_source_action <-
  base_cost_bar %+%
  (df_prj %>%
     ungroup() %>%
     mutate_at(
       vars(starts_with("action_")),
       as.numeric
     ) %>%
     mutate_at(
       vars(starts_with("action_")),
       list(~ .*adj_cost)
     ) %>%
     group_by(project_source) %>%
     summarize_at(
       vars(starts_with("action_")),
       list(~sum(., na.rm = TRUE))
     ) %>%
     pivot_longer(
       starts_with("action_"),
       names_to = "action",
       names_prefix = "action_",
       values_to = "adj_cost"
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
     mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE)) %>%
     filter(action_full %in% action_levels_spend[1:16]) %>%
     filter(project_source %in% source_levels_spend[1:8])
  ) +
  aes(
    x = reorder(action_full, adj_cost)
  ) +
  ggtitle("Expenditures ($thous), by source and action type", "16 (of 82) action types with highest expenditures by \n8 (of 38) sources with highest expenditures") +
  facet_wrap(~ source_fac, ncol = 2, labeller = label_wrap_gen(width = 25))

# By source and basin
fig_spend_source_basin <-
  base_cost_bar %+%
  (df_prj %>%
     group_by(project_source, basin) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE)) %>%
     drop_na() %>%
     mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE)) %>%
     mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE)) %>%
     filter(basin %in% basin_levels_spend[1:8]) %>%
     filter(project_source %in% source_levels_spend[1:8])
  ) +
  aes(
    x = reorder(project_source, adj_cost)
  ) +
  facet_wrap(~ basin_fac, ncol = 2, labeller = label_wrap_gen(width = 25)) +
  ggtitle("Expenditures ($thou), by source and basin", "8 (of 47) basins with highest expenditures and \n8 (of 38) sources with highest expenditures")
```

#### By Year
> **Observation:** Expenditures have been rising overall and for almost all major actions over time, with the exception of road drainage improvements (see note in the Action and Project Counts section above). Expenditures per project and per action have been rising over time as well. This may be because agencies are attempting more complex projects and extensive actions, or because the mix of actions is shifting towards more expensive actions. It may also be that the "low hanging fruit" is all gone and that there simply aren't more actions available. Of course, it could also be that costs are just rising over time (though I have already adjusted for inflation). As seen in the Counts figures, there is a noticeable drop in spending in the year of the financial crisis, though overall spending quickly recovers.

```{r figs_spend_byyear}
fig_spend_year
fig_spend_year_basin
fig_spend_year_source
```
```{r figs_spend_byyear2, fig.dim = c(10,12)}
fig_spend_year_action
```
\
[Back to top](#expend-top)

#### By Action Type
> **Observation:** Projects involving direct habitat interventions like riparian planting and in-stream placement of large woody debris, log jams, weirs, rootwads, and boulders make up the bulk of the spending. For multiple action projects, these sorts of actions tend to be reported together, which might explain their clustering at the top the total expenditure figures. These projects appear throughout the region, but Puget Sound has seen the most investment by a wide margin. Overall, these projects are the most widespread and represent the bulk of spending.
\

> **Observation:** The bulk of the land acquisition spending is in the Puget Sound. Habitat Work Schedule and WA RCO (including SRFBD projects) report the most spending on these projects, and both operate mainly in the Puget Sound region. On the other hand, OWRI does not report land acquisition projects, so we may be getting an incomplete picture of acquisition activity in Oregon. Land acquisitions are clearly the most expensive actions, so including them together with other actions might obscure some signal.

```{r figs_spend_byaction, fig.dim = c(10,12)}
fig_spend_action
fig_spend_year_action
fig_spend_basin_action
fig_spend_source_action
```
\
[Back to top](#expend-top)

#### By Basin
```{r figs_spend_bybasin}
fig_spend_basin
fig_spend_year_basin
fig_spend_source_basin
```
```{r figs_spend_byybasin2, fig.dim = c(10,12)}
fig_spend_basin_action
```
\
[Back to top](#expend-top)

#### By Reporting Source
> **Observation:** Only 22 of the 38 sources report any costs at all. The top six sources account for the vast majority of reported spending.

```{r figs_spend_bysource}
fig_spend_source
fig_spend_year_source
fig_spend_source_basin
```
```{r figs_spend_bysource2, fig.dim = c(10,12)}
fig_spend_source_action
```
\
[Back to top](#expend-top)

```{r figsremove_spend, include = FALSE}
rm(
  fig_spend_source,
  fig_spend_source_action,
  fig_spend_year_source,
  fig_spend_source_basin,
  fig_spend_basin,
  fig_spend_basin_action,
  fig_spend_year_basin,
  fig_spend_action,
  fig_spend_year_action,
  fig_spend_year
)
```

### Per Project {.tabset .tabset-fade .tabset-pills}
These figures represent expenditures per project *with reported costs*.
```{r figsbuild_spendproj, include = FALSE}
# Spending per project ====
# By action
# Note these figures represent expenditures per project with reported costs
fig_spendproj_action <-
  base_cost_bar %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     ungroup() %>%
     mutate_at(
       vars(starts_with("action_")),
       as.numeric
     ) %>%
     mutate_at(
       vars(starts_with("action_")),
       list(~ .*adj_cost)
     ) %>%
     summarize_at(
       vars(starts_with("action_")),
       list(~sum(., na.rm = TRUE)/sum(I(. > 0), na.rm = TRUE))
     ) %>%
     pivot_longer(
       everything(),
       names_to = "action",
       names_prefix = "action_",
       values_to = "adj_cost"
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     filter(action_full %in% action_levels[1:50])
  ) +
  aes(
    x = reorder(action_full, adj_cost)
  ) +
  ggtitle("Expenditures per project ($thou), by action type", "50 (of 82) most common action types")

# By year
fig_spendproj_year <-
  base_cost_line %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     group_by(completed_year) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE)/ sum(!is.na(adj_cost)))
  ) +
  ggtitle("Expenditures per project ($thou), by year")
fig_spendproj_year

# By basin
fig_spendproj_basin <-
  base_cost_bar %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     group_by(basin) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE)/ sum(!is.na(adj_cost))) %>%
     drop_na()
  ) +
  aes(
    x = reorder(basin, adj_cost)
  ) +
  ggtitle("Expenditures per project ($thou), by basin")

# By source
fig_spendproj_source <-
  base_cost_bar %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     group_by(project_source) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(!is.na(adj_cost))) %>%
     drop_na()
  ) +
  aes(
    x = reorder(project_source, adj_cost)
  ) +
  ggtitle("Expenditures per project ($thou), by source")

# By year and action
fig_spendproj_year_action <-
  base_cost_line %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     ungroup() %>%
     mutate_at(
       vars(starts_with("action_")),
       as.numeric
     ) %>%
     mutate_at(
       vars(starts_with("action_")),
       list(~ .*adj_cost)
     ) %>%
     group_by(completed_year) %>%
     summarize_at(
       vars(starts_with("action_")),
       list(~sum(., na.rm = TRUE)/ sum(!is.na(adj_cost)))
     ) %>%
     pivot_longer(
       starts_with("action_"),
       names_to = "action",
       names_prefix = "action_",
       values_to = "adj_cost"
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
     filter(action_full %in% action_levels_spend[1:18])
  ) +
  ggtitle("Expenditures per project ($thou), by year and action type", "18 (of 82) action types with highest expenditures") +
  facet_wrap(~ action_fac, ncol = 3, labeller = label_wrap_gen(width = 25))

# By year and basin
fig_spendproj_year_basin <-
  base_cost_line %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     group_by(completed_year, basin) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(!is.na(adj_cost))) %>%
     drop_na() %>%
     mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE)) %>%
     filter(basin %in% basin_levels_spend[1:12])
  ) +
  ggtitle("Expenditures per project ($thou), by year and basin", "12 (of 47) basins with highest expenditures") +
  facet_wrap(~ basin_fac, ncol = 3, labeller = label_wrap_gen(width = 25))

# By year and source
fig_spendproj_year_source <-
  base_cost_line %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     group_by(completed_year, project_source) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(!is.na(adj_cost))) %>%
     drop_na() %>%
     mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE)) %>%
     filter(project_source %in% source_levels_spend[1:8])
  ) +
  ggtitle("Expenditures per project ($thou), by year and source", "8 (of 38) sources with highest reported expenditures") +
  facet_wrap(~ source_fac, ncol = 2, labeller = label_wrap_gen(width = 25))

# By basin and action
fig_spendproj_basin_action <-
  base_cost_bar %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     ungroup() %>%
     mutate_at(
       vars(starts_with("action_")),
       as.numeric
     ) %>%
     mutate_at(
       vars(starts_with("action_")),
       list(~ .*adj_cost)
     ) %>%
     group_by(basin) %>%
     summarize_at(
       vars(starts_with("action_")),
       list(~sum(., na.rm = TRUE) / sum(!is.na(adj_cost)))
     ) %>%
     pivot_longer(
       starts_with("action_"),
       names_to = "action",
       names_prefix = "action_",
       values_to = "adj_cost"
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
     mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE)) %>%
     filter(action_full %in% action_levels_spend[1:16]) %>%
     filter(basin %in% basin_levels_spend[1:8])
  ) +
  aes(
    x = reorder(action_full, adj_cost)
  ) +
  ggtitle("Expenditures per project ($thous), by basin and action type", "16 (of 82) action types with highest expenditures in \n8 (of 47) basins with highest expenditures") +
  facet_wrap(~ basin_fac, ncol = 2, labeller = label_wrap_gen(width = 25))

# By source and action
fig_spendproj_source_action <-
  base_cost_bar %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     ungroup() %>%
     mutate_at(
       vars(starts_with("action_")),
       as.numeric
     ) %>%
     mutate_at(
       vars(starts_with("action_")),
       list(~ .*adj_cost)
     ) %>%
     group_by(project_source) %>%
     summarize_at(
       vars(starts_with("action_")),
       list(~sum(., na.rm = TRUE) / sum(!is.na(adj_cost)))
     ) %>%
     pivot_longer(
       starts_with("action_"),
       names_to = "action",
       names_prefix = "action_",
       values_to = "adj_cost"
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
     mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE)) %>%
     filter(action_full %in% action_levels_spend[1:16]) %>%
     filter(project_source %in% source_levels_spend[1:8])
  ) + 
  aes(
    x = reorder(action_full, adj_cost)
  ) +
  ggtitle("Expenditures per project ($thous), by source and action type", "16 (of 82) action types with highest expenditures by \n8 (of 38) sources with highest expenditures") +
  facet_wrap(~ source_fac, ncol = 2, labeller = label_wrap_gen(width = 25))

# By source and basin
fig_spendproj_source_basin <-
  base_cost_bar %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     group_by(project_source, basin) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(!is.na(adj_cost))) %>%
     drop_na() %>%
     mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE)) %>%
     mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE)) %>%
     filter(basin %in% basin_levels_spend[1:8]) %>%
     filter(project_source %in% source_levels_spend[1:8])
  ) +
  aes(
    x = reorder(project_source, adj_cost)
  ) +
  facet_wrap(~ basin_fac, ncol = 2, labeller = label_wrap_gen(width = 25)) +
  ggtitle("Expenditures per project ($thou), by source and basin", "8 (of 47) basins with highest expenditures and \n8 (of 38) sources with highest expenditures")
```

#### By Year
```{r figs_spendproj_byyear}
fig_spendproj_year
fig_spendproj_year_basin
fig_spendproj_year_source
```
```{r figs_spendprog_byyear2, fig.dim = c(10,12)}
fig_spendproj_year_action
```
\
[Back to top](#expend-top)

#### By Action Type
> **Observation:** Over $250mill has been spent on culvert improvement projects, making it the action with the third highest associated expenditures. However, per project costs for these projects is ranked much lower. This spending is spread concentrated along the western side of the Cascades (Puget Sound, Oregon Coastal, Willamette).

```{r figs_spendprog_byaction, fig.dim = c(10,12)}
fig_spendproj_action
fig_spendproj_year_action
fig_spendproj_basin_action
fig_spendproj_source_action
```
\
[Back to top](#expend-top)

#### By Basin
```{r figs_spendproj_bybasin}
fig_spendproj_basin
fig_spendproj_year_basin
fig_spendproj_source_basin
```
```{r figs_spendprog_bybasin2, fig.dim = c(10,12)}
fig_spendproj_basin_action
```
\
[Back to top](#expend-top)

#### By Reporting Source
> **Observation:** OWRI, which reports the bulk of the Oregon projects, consistently reports very low per project and per action costs. This may be because they do not report land acquisitions, which are the most expensive actions. OWRI also reports a disproportionate number of road drainage projects, which might drive down their costs. They also may just be computing their costs differently than other groups. But this is a red flag for directly comparing OWRI-reported projects to others.

```{r figs_spendproj_bysource}
fig_spendproj_source
fig_spendproj_year_source
fig_spendproj_source_basin
```
```{r figs_spendprog_bysource2, fig.dim = c(10,12)}
fig_spendproj_source_action
```
\
[Back to top](#expend-top)

```{r figsremove_spendproj, include = FALSE}
rm(
  fig_spendproj_source,
  fig_spendproj_source_action,
  fig_spendproj_year_source,
  fig_spendproj_source_basin,
  fig_spendproj_basin,
  fig_spendproj_basin_action,
  fig_spendproj_year_basin,
  fig_spendproj_action,
  fig_spendproj_year_action,
  fig_spendproj_year
)
```

### Per Action {.tabset .tabset-fade .tabset-pills}
*Note:* These figures represent expenditures per action for projects *with reported costs*.
```{r figsbuild_spendact, include = FALSE}
# Spending per action ====
# Note these figures represent expenditures per action for projects with reported costs

# Prepare action count for joining denominator
df_actcount <-
  df_prj %>%
  drop_na(adj_cost) %>%
  ungroup() %>%
  mutate_at(
    vars(starts_with("action_")),
    as.numeric
  ) %>%
  mutate_at(
    vars(starts_with("action_")),
    list(n_action_act = ~ .*n_action_prj)
  ) %>%
  pivot_longer(
    ends_with("_n_action_act"),
    names_to = "action",
    names_prefix = "action_",
    values_to = "n_action_act"
  ) %>%
  mutate(
    action = str_remove(action, "_n_action_act")
  )

# Prep joining character vector for join by variables
join_actcount <-
  c(
    "project_id",
    "project_year",
    "completed_year",
    "latitude",
    "longitude",
    "basin",
    "project_source",
    "project_cost",
    "n_worksites",
    "n_action_prj",
    "n_action_prj_dist",
    "n_metric_prj",
    "n_metric_prj_dist",
    "same_action",
    "missing_metric",
    "action_sedireduce_sedicont",
    "action_agri_mgmt",
    "action_livestock_water",
    "action_uplandveg_slope",
    "action_livestock_fence",
    "action_uplandveg_plant",
    "action_riparian_plant",
    "action_riparian_fence",
    "action_sedireduce_roaddrain",
    "action_sedireduce_roadobli",
    "action_instream_barbs",
    "action_instream_bankstab",
    "action_instream_logjam",
    "action_fishpass_culvimp",
    "action_sedireduce_contstruc",
    "action_instream_rootwad",
    "action_riparian_watergap",
    "action_agri_structure",
    "action_instream_wooddebris",
    "action_riparian_weed",
    "action_livestock_graze",
    "action_wetland_imp",
    "action_riparian_forest",
    "action_uplandveg_invasive",
    "action_uplandveg_standmgmt",
    "action_instream_connect",
    "action_fishpass_culvrem",
    "action_sedireduce_roadrecon",
    "action_fishpass_barriers",
    "action_instream_boulder",
    "action_est_resthab",
    "action_wetland_restore",
    "action_fishpass_roadcross",
    "action_sedireduce_roadrelo",
    "action_sedireduce_roadcross",
    "action_land_wetland",
    "action_riparian_graze",
    "action_instream_gravel",
    "action_instream_offchannel",
    "action_instream_reconf",
    "action_instream_logweir",
    "action_flow_irriimp",
    "action_est_fillrem",
    "action_fishpass_ladderinst",
    "action_land_streambank",
    "action_instream_beaver",
    "action_instream_rockweir",
    "action_fishpass_ladderimp",
    "action_fishpass_diverdam",
    "action_fishpass_waysinst",
    "action_screen_inst",
    "action_screen_replace",
    "action_flow_waterlease",
    "action_fishpass_weirs",
    "action_est_dikebreach",
    "action_wqimp_toxic",
    "action_wetland_create",
    "action_riparian_liveexcl",
    "action_riparian_livewater",
    "action_fishpass_culvinst",
    "action_wetland_plant",
    "action_instream_plantrem",
    "action_est_dikereconf",
    "action_nutrient_carcanalog",
    "action_nutrient_carcplace",
    "action_nutrient_fert",
    "action_instream_predrem",
    "action_fishpass_rockford",
    "action_wqimp_refuse",
    "action_wetland_plantrem",
    "action_wetland_invasive",
    "action_est_invasive",
    "action_est_tidegate",
    "action_est_chanmod",
    "action_agri_tillage",
    "action_wqimp_flowcool",
    "action_est_create",
    "action_est_armormod",
    "action_projmaint_sitemaint",
    "action_wqimp_wastewater",
    "action_wqimp_manure",
    "action_wqimp_sewage",
    "adj_cost",
    "action"
  )

# By action
fig_spendact_action <-
  base_cost_bar %+%
  (df_prj %>%
     ungroup() %>%
     mutate_at(
       vars(starts_with("action_")),
       as.numeric
     ) %>%
     mutate_at(
       vars(starts_with("action_")),
       list(adj_cost_act = ~ .*adj_cost)
     ) %>%
     pivot_longer(
       ends_with("_adj_cost_act"),
       names_to = "action",
       names_prefix = "action_",
       values_to = "adj_cost_act"
     ) %>%
     mutate(
       action = str_remove(action, "_adj_cost_act")
     ) %>%
     left_join(
       df_actcount,
       by = join_actcount
     ) %>%
     group_by(action) %>%
     summarize(
       adj_cost = sum(adj_cost_act, na.rm = TRUE) / sum(n_action_act, na.rm = TRUE)
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     filter(action_full %in% action_levels[1:50])
  ) +
  aes(
    x = reorder(action_full, adj_cost)
  ) +
  ggtitle("Expenditures per action ($thou), by action type", "50 (of 82) most common action types")

# By year
fig_spendact_year <-
  base_cost_line %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     group_by(completed_year) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE)/ sum(n_action_prj))
  ) +
  ggtitle("Expenditures per action ($thou), by year")
fig_spendact_year

# By basin
fig_spendact_basin <-
  base_cost_bar %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     group_by(basin) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE)/ sum(n_action_prj)) %>%
     drop_na()
  ) +
  aes(
    x = reorder(basin, adj_cost)
  ) +
  ggtitle("Expenditures per action ($thou), by basin")

# By source
fig_spendact_source <-
  base_cost_bar %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     group_by(project_source) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(n_action_prj)) %>%
     drop_na()
  ) +
  aes(
    x = reorder(project_source, adj_cost)
  ) +
  ggtitle("Expenditures per action ($thou), by source")

# By year and action
fig_spendact_year_action <-
  base_cost_line %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     ungroup() %>%
     mutate_at(
       vars(starts_with("action_")),
       as.numeric
     ) %>%
     mutate_at(
       vars(starts_with("action_")),
       list(adj_cost_act = ~ .*adj_cost)
     ) %>%
     pivot_longer(
       ends_with("_adj_cost_act"),
       names_to = "action",
       names_prefix = "action_",
       values_to = "adj_cost_act"
     ) %>%
     mutate(
       action = str_remove(action, "_adj_cost_act")
     ) %>%
     left_join(df_actcount, by = join_actcount) %>%
     group_by(action, completed_year) %>%
     summarize(
       adj_cost = sum(adj_cost_act, na.rm = TRUE) / sum(n_action_act, na.rm = TRUE)
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
     filter(action_full %in% action_levels_spend[1:18])
  ) +
  ggtitle("Expenditures per action ($thou), by year and action type", "18 (of 82) action types with highest expenditures") +
  theme(
    strip.text = element_text(size = 8)
  ) +
  facet_wrap(~ action_fac, ncol = 3, labeller = label_wrap_gen(width = 25))

# By year and basin
fig_spendact_year_basin <-
  base_cost_line %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     group_by(completed_year, basin) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(n_action_prj)) %>%
     drop_na() %>%
     mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE)) %>%
     filter(basin %in% basin_levels_spend[1:12])
  ) +
  ggtitle("Expenditures per action ($thou), by year and basin", "12 (of 47) basins with highest expenditures") +
  facet_wrap(~ basin_fac, ncol = 3, labeller = label_wrap_gen(width = 25))

# By year and source
fig_spendact_year_source <-
  base_cost_line %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     group_by(completed_year, project_source) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(n_action_prj)) %>%
     drop_na() %>%
     mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE)) %>%
     filter(project_source %in% source_levels_spend[1:8])
  ) +
  ggtitle("Expenditures per action ($thou), by year and source", "8 (of 38) sources with highest reported expenditures") +
  facet_wrap(~ source_fac, ncol = 2, labeller = label_wrap_gen(width = 25))

# By basin and action
fig_spendact_basin_action <-
  base_cost_bar %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     ungroup() %>%
     mutate_at(
       vars(starts_with("action_")),
       as.numeric
     ) %>%
     mutate_at(
       vars(starts_with("action_")),
       list(adj_cost_act = ~ .*adj_cost)
     ) %>%
     pivot_longer(
       ends_with("_adj_cost_act"),
       names_to = "action",
       names_prefix = "action_",
       values_to = "adj_cost_act"
     ) %>%
     mutate(
       action = str_remove(action, "_adj_cost_act")
     ) %>%
     left_join(df_actcount, by = join_actcount) %>%
     group_by(action, basin) %>%
     summarize(
       adj_cost = sum(adj_cost_act, na.rm = TRUE) / sum(n_action_act, na.rm = TRUE)
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
     mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE)) %>%
     filter(action_full %in% action_levels_spend[1:16]) %>%
     filter(basin %in% basin_levels_spend[1:8])
  ) +
  aes(
    x = reorder(action_full, adj_cost)
  ) +
  ggtitle("Expenditures per action ($thous), by basin and action type", "16 (of 82) action types with highest expenditures in \n8 (of 47) basins with highest expenditures") +
  facet_wrap(~ basin_fac, ncol = 2, labeller = label_wrap_gen(width = 25))

# By source and action
fig_spendact_source_action <-
  base_cost_bar %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     ungroup() %>%
     mutate_at(
       vars(starts_with("action_")),
       as.numeric
     ) %>%
     mutate_at(
       vars(starts_with("action_")),
       list(adj_cost_act = ~ .*adj_cost)
     ) %>%
     pivot_longer(
       ends_with("_adj_cost_act"),
       names_to = "action",
       names_prefix = "action_",
       values_to = "adj_cost_act"
     ) %>%
     mutate(
       action = str_remove(action, "_adj_cost_act")
     ) %>%
     left_join(df_actcount, by = join_actcount) %>%
     group_by(action, project_source) %>%
     summarize(
       adj_cost = sum(adj_cost_act, na.rm = TRUE) / sum(n_action_act, na.rm = TRUE)
     ) %>%
     mutate(action_full = recode(action, !!!invert(action_key))) %>%
     mutate(action_fac = factor(action_full, action_levels_spend, ordered = TRUE)) %>%
     mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE)) %>%
     filter(action_full %in% action_levels_spend[1:16]) %>%
     filter(project_source %in% source_levels_spend[1:8])
  ) +
  aes(
    x = reorder(action_full, adj_cost)
  ) +
  ggtitle("Expenditures per action ($thous), by source and action type", "16 (of 82) action types with highest expenditures by \n8 (of 38) sources with highest expenditures") +
  facet_wrap(~ source_fac, ncol = 2, labeller = label_wrap_gen(width = 25))

# By source and basin
fig_spendact_source_basin <-
  base_cost_bar %+%
  (df_prj %>%
     drop_na(adj_cost) %>%
     group_by(project_source, basin) %>%
     summarize(adj_cost = sum(adj_cost, na.rm = TRUE) / sum(n_action_prj)) %>%
     drop_na() %>%
     mutate(basin_fac = factor(basin, basin_levels_spend, ordered = TRUE)) %>%
     mutate(source_fac = factor(project_source, source_levels_spend, ordered = TRUE)) %>%
     filter(basin %in% basin_levels_spend[1:8]) %>%
     filter(project_source %in% source_levels_spend[1:8])
  ) +
  aes(
    x = reorder(project_source, adj_cost)
  ) +
  facet_wrap(~ basin_fac, ncol = 2, labeller = label_wrap_gen(width = 25)) +
  ggtitle("Expenditures per action ($thou), by source and basin", "8 (of 47) basins with highest expenditures and \n8 (of 38) sources with highest expenditures")
```

#### By Year
```{r figs_spendact_byyear}
fig_spendact_year
fig_spendact_year_basin
fig_spendact_year_source
```
```{r figs_spendact_byyear2, fig.dim = c(10,12)}
fig_spendact_year_action
```
\
[Back to top](#expend-top)

#### By Action Type
> **Observation:** On a per action basis, projects involving channel modification have the second highest costs after land acquisition. Notably, these projects are more expensive on a per action basis than other in-stream actions like weirs, large woody debris, boulders, etc.

```{r figs_spendact_byaction, fig.dim = c(10,12)}
fig_spendact_action
fig_spendact_year_action
fig_spendact_basin_action
fig_spendact_source_action
```
\
[Back to top](#expend-top)

#### By Basin
```{r figs_spendact_bybasin}
fig_spendact_basin
fig_spendact_year_basin
fig_spendact_source_basin
```
```{r figs_spendact_bybasin2, fig.dim = c(10,12)}
fig_spendact_basin_action
```
\
[Back to top](#expend-top)

#### By Reporting Source
```{r figs_spendact_bysource}
fig_spendact_source
fig_spendact_year_source
fig_spendact_source_basin
```
```{r figs_spendact_bysource2, fig.dim = c(10,12)}
fig_spendact_source_action
```
\
[Back to top](#expend-top)

```{r figsremove_spendact}
rm(
  fig_spendact_source,
  fig_spendact_source_action,
  fig_spendact_year_source,
  fig_spendact_source_basin,
  fig_spendact_basin,
  fig_spendact_basin_action,
  fig_spendact_year_basin,
  fig_spendact_action,
  fig_spendact_year_action,
  fig_spendact_year
)
```
# Conclusions
1. ***Cost and metric availability varies dramatically between actions and reporting source.*** While there is a lot of interesting data here, inconsistencies in how the data are reported how they can be used. This will be a bigger problem for some actions than others. For example, culverts and instream debris are distinct actions where metric may be less important. Costs for actions like riparian planting will be more difficult to deal with.
2. ***Differences between reporting sources will limit the ability to model absolute cost levels.*** For example, OWRI projects are consistently far cheaper than those reported by Habitat Work Schedule, even for the same actions. While drivers of costs can still be modelled by controlling for these differences with fixed effects, accurately predicting total costs out-of-sample will be difficult. Comparing two out-of-sample projects and predicting which would be more expensive should be possible, but accurately predicting exact costs for each might not be.
3. ***Focusing on culverts going forward in the near term.*** Because culverts are discrete actions, a simple count of "culverts per project" serves as a good measure of scale. Fish access is a major policy issue, made especially relevant by the 2018 U.S. Supreme Court *Washington v. United States* ruling which requires the State of Washington to improve hundreds of state-owned culverts across Western Washington.

# End Matter
```{r endmatter, message = TRUE, warning = TRUE}
# Created on...
Sys.time()

# Using...
sessionInfo()
```